<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Tree Garden - ระบบห้องเรียนแบบเกม</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Fredoka+One:wght@400&display=swap');
        
        * {
            font-family: 'Kanit', sans-serif;
        }
        
        .game-title {
            font-family: 'Fredoka One', cursive;
        }
        
        :root {
            --primary: #4CAF50;
            --secondary: #FFB74D;
            --accent: #FF6B6B;
            --sky: #87CEEB;
            --dark: #2E3440;
            --light: #F6F8FA;
            --highlight: #FFD700;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, var(--sky) 0%, #B8E6B8 50%, var(--primary) 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .tree-3d {
            transform-style: preserve-3d;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.2));
        }
        
        .tree-3d:hover {
            transform: scale(1.1) rotateY(10deg) rotateX(5deg);
        }
        
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.3); }
            50% { box-shadow: 0 0 40px rgba(76, 175, 80, 0.6); }
        }
        
        .notification-slide {
            animation: slideInRight 0.5s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .water-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .water-drop {
            position: absolute;
            width: 12px;
            height: 16px;
            background: linear-gradient(135deg, #87CEEB 0%, #4682B4 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: waterDropFall 1.5s ease-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 2px rgba(255,255,255,0.3);
        }
        
        @keyframes waterDropFall {
            0% { 
                transform: translateY(-100px) scale(0.5); 
                opacity: 0; 
            }
            20% { 
                opacity: 1; 
                transform: translateY(-50px) scale(0.8); 
            }
            80% { 
                transform: translateY(50px) scale(1); 
                opacity: 0.8; 
            }
            100% { 
                transform: translateY(100px) scale(1.2); 
                opacity: 0; 
            }
        }
        
        .rain-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .rain-drop {
            position: absolute;
            width: 2px;
            height: 15px;
            background: linear-gradient(180deg, rgba(135, 206, 235, 0.8) 0%, rgba(70, 130, 180, 0.9) 100%);
            border-radius: 0 0 50% 50%;
            animation: rainDropFall 1s linear;
        }
        
        @keyframes rainDropFall {
            0% { 
                transform: translateY(-120px); 
                opacity: 0.8; 
            }
            100% { 
                transform: translateY(120px); 
                opacity: 0; 
            }
        }
        
        .fertilizer-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .fertilizer-drop {
            position: absolute;
            width: 10px;
            height: 12px;
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 50%, #654321 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            animation: fertilizerDropFall 1.8s ease-out;
            box-shadow: 0 2px 3px rgba(0,0,0,0.3);
        }
        
        @keyframes fertilizerDropFall {
            0% { 
                transform: translateY(-80px) scale(0.3); 
                opacity: 0; 
            }
            30% { 
                opacity: 1; 
                transform: translateY(-20px) scale(0.8); 
            }
            70% { 
                transform: translateY(40px) scale(1); 
                opacity: 0.9; 
            }
            100% { 
                transform: translateY(80px) scale(1.1); 
                opacity: 0; 
            }
        }
        
        .worm-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        
        .worm-body {
            position: absolute;
            width: 25px;
            height: 6px;
            background: linear-gradient(90deg, #8B4513 0%, #A0522D 30%, #8B4513 60%, #654321 100%);
            border-radius: 3px;
            animation: wormCrawl 3s ease-in-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .worm-body::before {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: #654321;
            border-radius: 50%;
            left: -2px;
            top: 1px;
            box-shadow: 2px 0 0 #654321, 4px 0 0 #654321;
        }
        
        @keyframes wormCrawl {
            0% { 
                transform: translateX(-60px) translateY(60px) rotate(-10deg); 
                opacity: 0; 
            }
            20% { 
                opacity: 1; 
                transform: translateX(-30px) translateY(40px) rotate(5deg); 
            }
            40% { 
                transform: translateX(0px) translateY(20px) rotate(-5deg); 
            }
            60% { 
                transform: translateX(20px) translateY(10px) rotate(10deg); 
            }
            80% { 
                transform: translateX(40px) translateY(-10px) rotate(-5deg); 
            }
            100% { 
                transform: translateX(70px) translateY(-30px) rotate(15deg); 
                opacity: 0; 
            }
        }
        
        .sick-effect {
            animation: sickShake 0.5s ease-in-out 3;
            filter: sepia(1) hue-rotate(60deg) saturate(0.8);
        }
        
        @keyframes sickShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .storm-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            background: linear-gradient(45deg, rgba(75, 85, 99, 0.3) 0%, rgba(107, 114, 128, 0.4) 50%, rgba(75, 85, 99, 0.3) 100%);
            animation: stormShake 2s ease-out;
        }
        
        .lightning {
            position: absolute;
            width: 3px;
            height: 60px;
            background: linear-gradient(180deg, #FFFF00 0%, #FFD700 50%, #FFA500 100%);
            border-radius: 1px;
            animation: lightning 0.3s ease-out;
            box-shadow: 0 0 10px #FFFF00, 0 0 20px #FFD700;
        }
        
        @keyframes stormShake {
            0%, 100% { transform: rotate(0deg) scale(1); opacity: 0; }
            10% { transform: rotate(-2deg) scale(1.05); opacity: 0.8; }
            20% { transform: rotate(2deg) scale(1.1); opacity: 0.9; }
            30% { transform: rotate(-1deg) scale(1.05); opacity: 0.7; }
            40% { transform: rotate(1deg) scale(1.08); opacity: 0.8; }
            50% { transform: rotate(-2deg) scale(1.1); opacity: 0.9; }
            60% { transform: rotate(2deg) scale(1.05); opacity: 0.7; }
            70% { transform: rotate(-1deg) scale(1.08); opacity: 0.8; }
            80% { transform: rotate(1deg) scale(1.05); opacity: 0.6; }
            90% { transform: rotate(-1deg) scale(1.02); opacity: 0.4; }
        }
        
        @keyframes lightning {
            0% { opacity: 0; transform: scaleY(0); }
            50% { opacity: 1; transform: scaleY(1); }
            100% { opacity: 0; transform: scaleY(0.8); }
        }
        
        .btn-3d {
            background: linear-gradient(145deg, var(--primary), #45a049);
            box-shadow: 0 8px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        
        .btn-3d:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(76, 175, 80, 0.4);
        }
        
        .btn-3d:active {
            transform: translateY(1px);
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }
        
        .progress-3d {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: progressPulse 2s infinite alternate;
        }
        
        @keyframes progressPulse {
            0% { box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 10px rgba(76, 175, 80, 0.3); }
            100% { box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 20px rgba(76, 175, 80, 0.6); }
        }
        
        .wheel-container {
            perspective: 1000px;
        }
        
        .wheel-3d {
            transform-style: preserve-3d;
            transition: transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.3));
        }
        
        .wheel-glow {
            animation: wheelGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes wheelGlow {
            0% { 
                filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.3)) drop-shadow(0 0 20px rgba(255, 215, 0, 0.3)); 
            }
            100% { 
                filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.3)) drop-shadow(0 0 40px rgba(255, 215, 0, 0.6)); 
            }
        }
        
        .wheel-spinning {
            animation: wheelSpin 0.1s linear infinite;
        }
        
        @keyframes wheelSpin {
            0% { filter: brightness(1) saturate(1); }
            50% { filter: brightness(1.2) saturate(1.3); }
            100% { filter: brightness(1) saturate(1); }
        }
        
        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            70% {
                transform: scale(0.9);
                opacity: 0.9;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .student-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            backdrop-filter: blur(10px);
            border: 2px solid rgba(76, 175, 80, 0.2);
            transition: all 0.3s ease;
        }
        
        .student-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 15px 30px rgba(76, 175, 80, 0.2);
        }
        
        .tree-selection {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .tree-selection:hover {
            transform: scale(1.1) rotateY(10deg);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .tree-selection.selected {
            border-color: var(--highlight);
            background: linear-gradient(145deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .action-btn {
            background: linear-gradient(145deg, var(--secondary), #FF8F00);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 183, 77, 0.4);
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .action-btn:hover::before {
            left: 100%;
        }
        
        /* Accessibility Styles */
        .reduced-motion * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        .high-contrast {
            filter: contrast(150%) brightness(110%);
        }
        
        .high-contrast .glass-card {
            background: rgba(255, 255, 255, 1);
            border: 2px solid #000;
        }
        
        .high-contrast .btn-3d {
            background: #000 !important;
            color: #fff !important;
            border: 2px solid #fff;
        }
        
        body.font-large {
            font-size: 1.2em;
        }
        
        body.font-extra-large {
            font-size: 1.5em;
        }
        
        @keyframes fireworkExplode {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(calc(-50% + var(--end-x)), calc(-50% + var(--end-y))) scale(0);
                opacity: 0;
            }
        }
        
        @keyframes sparkle {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes notificationRipple {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(4);
                opacity: 0;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="gradient-bg">
    <!-- หน้าเข้าสู่ระบบ -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-6">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md floating">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">🌳</div>
                <h1 class="game-title text-4xl text-green-600 mb-2">Interactive Tree Garden</h1>
                <p class="text-gray-600 text-lg">ระบบห้องเรียนแบบเกม</p>
                <div class="mt-4 text-sm text-gray-500">
                    ปลูกต้นไม้แห่งความรู้ไปด้วยกัน
                </div>
            </div>
            
            <div class="space-y-4">
                <button onclick="showLogin('teacher')" class="w-full btn-3d text-white py-4 rounded-2xl font-bold text-lg flex items-center justify-center space-x-3">
                    <span class="text-2xl">👩‍🏫</span>
                    <span>เข้าสู่ระบบครู</span>
                </button>
                <button onclick="showLogin('student')" class="w-full btn-3d text-white py-4 rounded-2xl font-bold text-lg flex items-center justify-center space-x-3">
                    <span class="text-2xl">🎓</span>
                    <span>เข้าสู่ระบบนักเรียน</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ฟอร์มเข้าสู่ระบบครู -->
    <div id="teacherLogin" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="text-5xl mb-4">👩‍🏫</div>
                <h2 class="game-title text-3xl text-purple-600">เข้าสู่ระบบครู</h2>
            </div>
            <div class="space-y-4">
                <input type="text" id="teacherUsername" placeholder="ชื่อผู้ใช้" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                <input type="password" id="teacherPassword" placeholder="รหัสผ่าน" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                <button onclick="teacherLogin()" class="w-full btn-3d text-white py-4 rounded-2xl font-bold text-lg">เข้าสู่ระบบ</button>
                <div class="text-center space-y-2">
                    <button onclick="showTeacherRegister()" class="text-blue-600 hover:text-blue-800 font-bold underline block">สร้างบัญชีใหม่</button>
                    <button onclick="showForgotPassword()" class="text-orange-600 hover:text-orange-800 font-bold underline block">ลืมรหัสผ่าน?</button>
                </div>
                <button onclick="backToMain()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-2xl font-bold">กลับ</button>
            </div>
        </div>
    </div>

    <!-- ฟอร์มสมัครสมาชิกครู -->
    <div id="teacherRegister" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="text-5xl mb-4">📝</div>
                <h2 class="game-title text-3xl text-green-600">สร้างบัญชีครู</h2>
                <p class="text-gray-600 mt-2">สร้างบัญชีเพื่อเริ่มใช้งานระบบ</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="registerFullName" placeholder="ชื่อ-นามสกุล" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                <input type="email" id="registerEmail" placeholder="อีเมล" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                <input type="text" id="registerUsername" placeholder="ชื่อผู้ใช้ (ภาษาอังกฤษ)" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                <input type="password" id="registerPassword" placeholder="รหัสผ่าน (อย่างน้อย 6 ตัว)" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                <input type="password" id="registerConfirmPassword" placeholder="ยืนยันรหัสผ่าน" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                <input type="text" id="registerSchool" placeholder="โรงเรียน/สถาบัน" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                <button onclick="teacherRegister()" class="w-full btn-3d text-white py-4 rounded-2xl font-bold text-lg">สร้างบัญชี</button>
                <div class="text-center">
                    <button onclick="showTeacherLogin()" class="text-blue-600 hover:text-blue-800 font-bold underline">มีบัญชีแล้ว? เข้าสู่ระบบ</button>
                </div>
                <button onclick="backToMain()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-2xl font-bold">กลับ</button>
            </div>
        </div>
    </div>

    <!-- ฟอร์มลืมรหัสผ่าน -->
    <div id="forgotPassword" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="text-5xl mb-4">🔑</div>
                <h2 class="game-title text-3xl text-orange-600">ลืมรหัสผ่าน</h2>
                <p class="text-gray-600 mt-2">กรอกชื่อผู้ใช้เพื่อรีเซ็ตรหัสผ่าน</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="forgotUsername" placeholder="ชื่อผู้ใช้" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                <button onclick="resetPassword()" class="w-full btn-3d text-white py-4 rounded-2xl font-bold text-lg">รีเซ็ตรหัสผ่าน</button>
                <div class="text-center">
                    <button onclick="showTeacherLogin()" class="text-blue-600 hover:text-blue-800 font-bold underline">กลับไปเข้าสู่ระบบ</button>
                </div>
                <button onclick="backToMain()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-2xl font-bold">กลับ</button>
            </div>
        </div>
    </div>

    <!-- ฟอร์มเข้าสู่ระบบนักเรียน -->
    <div id="studentLogin" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="glass-card rounded-3xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="text-5xl mb-4">🎓</div>
                <h2 class="game-title text-3xl text-green-600">ระบบนักเรียน</h2>
            </div>
            <div class="space-y-4">
                <input type="text" id="studentCode" placeholder="กรอกรหัสนักเรียน" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-center text-2xl font-bold tracking-wider">
                <button onclick="studentLogin()" class="w-full btn-3d text-white py-4 rounded-2xl font-bold text-lg">เข้าสู่สวน</button>
                <button onclick="backToMain()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-2xl font-bold">กลับ</button>
            </div>
        </div>
    </div>

    <!-- แดชบอร์ดครู -->
    <div id="teacherDashboard" class="hidden min-h-screen">
        <!-- Header -->
        <div class="glass-card mx-6 mt-6 rounded-2xl p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="text-4xl">🌳</div>
                    <div>
                        <h1 class="game-title text-2xl text-green-600">Teacher Dashboard</h1>
                        <p class="text-gray-600" id="teacherWelcomeText">จัดการห้องเรียนและติดตามความก้าวหน้า</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="font-bold text-gray-800" id="teacherNameDisplay"></div>
                        <div class="text-sm text-gray-600" id="teacherSchoolDisplay"></div>
                    </div>
                    <button onclick="showTeacherProfile()" class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl">
                        <span class="text-xl">👤</span>
                    </button>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold transition-all">ออกจากระบบ</button>
                </div>
            </div>
        </div>

        <div class="flex h-screen pt-6">
            <!-- Sidebar -->
            <div class="w-80 px-6">
                <div class="glass-card rounded-2xl p-6 h-full">
                    <h3 class="text-xl font-bold text-purple-600 mb-4 flex items-center">
                        <span class="text-2xl mr-2">📚</span>
                        ห้องเรียน
                    </h3>
                    
                    <!-- เพิ่มห้องเรียน -->
                    <div class="mb-6">
                        <input type="text" id="classroomName" placeholder="ชื่อห้องเรียน" class="w-full p-3 rounded-xl border-2 border-gray-200 mb-3 focus:border-green-500 outline-none">
                        <button onclick="createClassroom()" class="w-full btn-3d text-white py-3 rounded-xl font-bold">+ เพิ่มห้องเรียน</button>
                    </div>

                    <!-- รายการห้องเรียน -->
                    <div id="classroomsList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- จะถูกเติมด้วย JavaScript -->
                    </div>

                    <!-- เพิ่มนักเรียน -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="font-bold text-blue-600 mb-3 flex items-center">
                            <span class="text-xl mr-2">👥</span>
                            เพิ่มนักเรียน
                        </h4>
                        <select id="classroomSelect" class="w-full p-3 rounded-xl border-2 border-gray-200 mb-3 focus:border-green-500 outline-none">
                            <option value="">เลือกห้องเรียน</option>
                        </select>
                        <textarea id="studentNames" placeholder="ใส่ชื่อนักเรียน (แยกบรรทัด)" class="w-full p-3 rounded-xl border-2 border-gray-200 mb-3 h-24 focus:border-green-500 outline-none resize-none"></textarea>
                        <button onclick="addStudents()" class="w-full btn-3d text-white py-3 rounded-xl font-bold">เพิ่มนักเรียน</button>
                    </div>

                    <!-- สร้างภารกิจ -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="font-bold text-orange-600 mb-3 flex items-center">
                            <span class="text-xl mr-2">🎯</span>
                            สร้างภารกิจ
                        </h4>
                        <input type="text" id="missionTitle" placeholder="หัวข้อภารกิจ" class="w-full p-3 rounded-xl border-2 border-gray-200 mb-3 focus:border-green-500 outline-none">
                        <textarea id="missionDescription" placeholder="รายละเอียดภารกิจ" class="w-full p-3 rounded-xl border-2 border-gray-200 mb-3 h-20 focus:border-green-500 outline-none resize-none"></textarea>
                        <input type="number" id="missionReward" placeholder="คะแนนรางวัล" min="1" max="100" class="w-full p-3 rounded-xl border-2 border-gray-200 mb-3 focus:border-green-500 outline-none">
                        <button onclick="createMission()" class="w-full btn-3d text-white py-3 rounded-xl font-bold">สร้างภารกิจ</button>
                    </div>

                    <!-- สร้างประกาศ -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="font-bold text-purple-600 mb-3 flex items-center">
                            <span class="text-xl mr-2">📢</span>
                            สร้างประกาศ
                        </h4>
                        <input type="text" id="announcementTitle" placeholder="หัวข้อประกาศ" class="w-full p-3 rounded-xl border-2 border-gray-200 mb-3 focus:border-green-500 outline-none">
                        <textarea id="announcementMessage" placeholder="ข้อความประกาศ" class="w-full p-3 rounded-xl border-2 border-gray-200 mb-3 h-20 focus:border-green-500 outline-none resize-none"></textarea>
                        <button onclick="createAnnouncement()" class="w-full btn-3d text-white py-3 rounded-xl font-bold">ส่งประกาศ</button>
                    </div>

                    <!-- รายการภารกิจที่ใช้งานอยู่ -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="font-bold text-green-600 mb-3 flex items-center">
                            <span class="text-xl mr-2">📋</span>
                            ภารกิจที่ใช้งานอยู่
                        </h4>
                        <div id="teacherMissionsList" class="space-y-2 max-h-48 overflow-y-auto">
                            <!-- จะถูกเติมด้วย JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="flex-1 px-6">
                <div class="glass-card rounded-2xl p-6 h-full">
                    <!-- Students Grid -->
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">🌱</span>
                            สวนของนักเรียน
                            <span id="selectedClassroomName" class="ml-2 text-green-600"></span>
                        </h3>
                        <div id="studentsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 max-h-96 overflow-y-auto">
                            <!-- จะถูกเติมด้วย JavaScript -->
                        </div>
                    </div>

                    <!-- Class Position Board -->
                    <div class="border-t border-gray-200 pt-6 mb-6">
                        <h4 class="font-bold text-purple-600 mb-4 flex items-center">
                            <span class="text-xl mr-2">🏆</span>
                            อันดับคะแนนในห้อง
                        </h4>
                        <div id="classPositionBoard" class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-4 max-h-48 overflow-y-auto">
                            <!-- จะถูกเติมด้วย JavaScript -->
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="border-t border-gray-200 pt-6">
                        <h4 class="font-bold text-orange-600 mb-4 flex items-center">
                            <span class="text-xl mr-2">⚡</span>
                            การกระทำ
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                            <button onclick="showActionModal('water')" class="action-btn text-white py-3 px-4 rounded-xl font-bold text-sm flex flex-col items-center">
                                <span class="text-2xl mb-1">💧</span>
                                <span>รดน้ำ +10</span>
                            </button>
                            <button onclick="showActionModal('fertilizer')" class="action-btn text-white py-3 px-4 rounded-xl font-bold text-sm flex flex-col items-center">
                                <span class="text-2xl mb-1">🌱</span>
                                <span>ปุ๋ย +20</span>
                            </button>
                            <button onclick="showActionModal('rain')" class="action-btn text-white py-3 px-4 rounded-xl font-bold text-sm flex flex-col items-center">
                                <span class="text-2xl mb-1">🌧️</span>
                                <span>ฝน +30</span>
                            </button>
                            <button onclick="showActionModal('worm')" class="action-btn bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-xl font-bold text-sm flex flex-col items-center">
                                <span class="text-2xl mb-1">🐛</span>
                                <span>หนอน -10</span>
                            </button>
                            <button onclick="showActionModal('sick')" class="action-btn bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-xl font-bold text-sm flex flex-col items-center">
                                <span class="text-2xl mb-1">🤒</span>
                                <span>ป่วย -20</span>
                            </button>
                            <button onclick="showActionModal('storm')" class="action-btn bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-xl font-bold text-sm flex flex-col items-center">
                                <span class="text-2xl mb-1">⛈️</span>
                                <span>พายุ -30</span>
                            </button>
                        </div>
                        
                        <!-- Wheel of Names -->
                        <div class="mt-4 flex space-x-4">
                            <button onclick="showWheelModal()" class="btn-3d text-white py-3 px-6 rounded-xl font-bold flex items-center space-x-2">
                                <span class="text-2xl">🎯</span>
                                <span>วงล้อสุ่มชื่อ</span>
                            </button>
                            <button onclick="showTreeImageModal()" class="bg-purple-500 hover:bg-purple-600 text-white py-3 px-6 rounded-xl font-bold flex items-center space-x-2">
                                <span class="text-2xl">🎨</span>
                                <span>เปลี่ยนรูปต้นไม้</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- แดชบอร์ดนักเรียน -->
    <div id="studentDashboard" class="hidden min-h-screen p-6">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <div class="glass-card rounded-2xl p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <div class="text-5xl">🌱</div>
                        <div>
                            <h1 class="game-title text-3xl text-green-600" id="studentWelcome">ยินดีต้อนรับ!</h1>
                            <p class="text-gray-600 text-lg" id="studentProgress">ระดับ 1 - เมล็ดพันธุ์</p>
                            <p class="text-purple-600 font-bold" id="studentPosition">🏆 อันดับที่ - ในห้อง</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="showMissions()" class="relative bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-xl">
                            <span class="text-xl">🎯</span>
                            <span id="missionBadge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">0</span>
                        </button>
                        <button onclick="showNotifications()" class="relative bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-xl">
                            <span class="text-xl">📬</span>
                            <span id="notificationBadge" class="hidden absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">0</span>
                        </button>
                        <button onclick="showSettings()" class="bg-gray-500 hover:bg-gray-600 text-white p-3 rounded-xl">
                            <span class="text-xl">⚙️</span>
                        </button>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-bold">ออกจากระบบ</button>
                    </div>
                </div>
            </div>

            <!-- เลือกต้นไม้ -->
            <div id="treeSelection" class="hidden glass-card rounded-2xl p-8 mb-6">
                <h2 class="text-2xl font-bold text-center mb-6 flex items-center justify-center">
                    <span class="text-3xl mr-3">🌱</span>
                    เลือกต้นไม้ของคุณ
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div onclick="selectTree('apple')" class="tree-selection glass-card p-6 rounded-xl text-center cursor-pointer border-2 border-transparent">
                        <div class="text-5xl mb-3 tree-3d">🍎</div>
                        <div class="font-bold text-red-600">ต้นแอปเปิ้ล</div>
                    </div>
                    <div onclick="selectTree('orange')" class="tree-selection glass-card p-6 rounded-xl text-center cursor-pointer border-2 border-transparent">
                        <div class="text-5xl mb-3 tree-3d">🍊</div>
                        <div class="font-bold text-orange-600">ต้นส้ม</div>
                    </div>
                    <div onclick="selectTree('candy')" class="tree-selection glass-card p-6 rounded-xl text-center cursor-pointer border-2 border-transparent">
                        <div class="text-5xl mb-3 tree-3d">🍭</div>
                        <div class="font-bold text-pink-600">ต้นลูกอม</div>
                    </div>
                    <div onclick="selectTree('donut')" class="tree-selection glass-card p-6 rounded-xl text-center cursor-pointer border-2 border-transparent">
                        <div class="text-5xl mb-3 tree-3d">🍩</div>
                        <div class="font-bold text-yellow-600">ต้นโดนัท</div>
                    </div>
                    <div onclick="selectTree('sweet')" class="tree-selection glass-card p-6 rounded-xl text-center cursor-pointer border-2 border-transparent">
                        <div class="text-5xl mb-3 tree-3d">🧁</div>
                        <div class="font-bold text-purple-600">ต้นขนม</div>
                    </div>
                    <div onclick="selectTree('data')" class="tree-selection glass-card p-6 rounded-xl text-center cursor-pointer border-2 border-transparent">
                        <div class="text-5xl mb-3 tree-3d">💾</div>
                        <div class="font-bold text-blue-600">ต้นข้อมูล</div>
                    </div>
                </div>
            </div>

            <!-- สวนต้นไม้ -->
            <div class="glass-card rounded-2xl p-8 text-center">
                <!-- Progress Bar -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-2">
                        <span id="currentPoints" class="font-bold text-gray-700">0 คะแนน</span>
                        <span id="nextLevel" class="font-bold text-green-600">ถัดไป: 20 คะแนน</span>
                    </div>
                    <div class="bg-gray-200 rounded-full h-6 relative overflow-hidden">
                        <div id="progressBar" class="progress-3d h-6 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Tree Display -->
                <div class="relative inline-block mb-8">
                    <div id="treeDisplay" class="tree-3d text-9xl mb-4 relative">
                        🌱
                    </div>
                    <div id="effectOverlay" class="absolute inset-0 pointer-events-none"></div>
                </div>

                <div id="treeInfo" class="text-xl font-bold text-gray-800 mb-4">
                    เมล็ดพันธุ์ - เรียนรู้ต่อไปเพื่อให้ต้นไม้เติบโต!
                </div>

                <!-- Level Badge -->
                <div id="levelBadge" class="inline-block bg-gradient-to-r from-green-400 to-green-600 text-white px-6 py-2 rounded-full font-bold text-lg pulse-glow">
                    ระดับ 1
                </div>
            </div>

            <!-- สวนต้นไม้ที่เสร็จแล้ว -->
            <div id="gardenSection" class="hidden glass-card rounded-2xl p-8 mt-6">
                <h3 class="text-2xl font-bold text-center mb-6 flex items-center justify-center">
                    <span class="text-3xl mr-3">🏡</span>
                    สวนต้นไม้ของคุณ
                    <span id="gardenCount" class="ml-2 bg-purple-500 text-white px-3 py-1 rounded-full text-sm">0 ต้น</span>
                </h3>
                <div id="gardenGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                    <!-- จะถูกเติมด้วย JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal การกระทำ -->
    <div id="actionModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-4 text-center" id="actionTitle">เลือกนักเรียน</h3>
            <div class="mb-6">
                <select id="actionStudentSelect" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                    <option value="">เลือกนักเรียน</option>
                    <option value="all">นักเรียนทั้งหมด</option>
                </select>
            </div>
            <div class="flex space-x-4">
                <button onclick="applyAction()" class="flex-1 btn-3d text-white py-3 rounded-xl font-bold">ใช้การกระทำ</button>
                <button onclick="closeActionModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-bold">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Modal วงล้อสุ่มชื่อ -->
    <div id="wheelModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
        <div class="glass-card rounded-2xl p-4 sm:p-8 w-full max-w-4xl max-h-screen overflow-y-auto">
            <h3 class="text-xl sm:text-2xl font-bold mb-4 sm:mb-6 text-center">🎯 วงล้อสุ่มชื่อ</h3>
            
            <div class="wheel-container mb-4 sm:mb-6 flex justify-center">
                <div class="relative" id="wheelContainer">
                    <!-- Wheel Pointer -->
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-3 z-20">
                        <div class="relative">
                            <!-- Main pointer -->
                            <div class="w-0 h-0 border-l-6 border-r-6 border-b-16 sm:border-l-8 sm:border-r-8 sm:border-b-20 border-l-transparent border-r-transparent border-b-red-600 drop-shadow-2xl"></div>
                            <!-- Pointer highlight -->
                            <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-3 border-r-3 border-b-8 sm:border-l-4 sm:border-r-4 sm:border-b-10 border-l-transparent border-r-transparent border-b-red-400"></div>
                            <!-- Pointer base -->
                            <div class="absolute -bottom-2 left-1/2 transform -translate-x-1/2 w-4 h-4 sm:w-6 sm:h-6 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full border-2 border-white shadow-lg"></div>
                        </div>
                    </div>
                    
                    <!-- Wheel -->
                    <div id="wheelCanvas" class="wheel-3d rounded-full border-4 sm:border-8 border-yellow-400 relative overflow-hidden shadow-2xl" style="background: #f0f0f0;">
                        <canvas id="wheelSegments" class="absolute inset-0 rounded-full"></canvas>
                        
                        <!-- Center Circle -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-8 h-8 sm:w-12 md:w-16 sm:h-12 md:h-16 bg-yellow-400 rounded-full border-2 sm:border-4 border-white shadow-lg flex items-center justify-center">
                                <div class="text-lg sm:text-xl md:text-2xl">🎯</div>
                            </div>
                        </div>
                        
                        <!-- Names Display -->
                        <div id="wheelNames" class="absolute inset-0 pointer-events-none">
                            <!-- Names will be positioned here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-6">
                <button onclick="spinWheel()" id="spinButton" class="btn-3d text-white px-8 py-4 rounded-xl font-bold text-lg">
                    🎲 หมุนวงล้อ
                </button>
            </div>
            
            <div id="wheelResult" class="hidden text-center mb-4">
                <div class="text-2xl font-bold text-green-600 mb-2">🎉 ผู้ชนะ!</div>
                <div id="winnerName" class="text-xl font-bold"></div>
            </div>
            
            <div class="text-center">
                <button onclick="closeWheelModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Modal ภารกิจ -->
    <div id="missionModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-center flex items-center justify-center">
                <span class="text-3xl mr-2">🎯</span>
                ภารกิจ
            </h3>
            <div id="missionsList" class="space-y-3 mb-6">
                <!-- จะถูกเติมด้วย JavaScript -->
            </div>
            <div class="text-center">
                <button onclick="closeMissionModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Modal การแจ้งเตือน -->
    <div id="notificationModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-center flex items-center justify-center">
                <span class="text-3xl mr-2">📬</span>
                การแจ้งเตือน
            </h3>
            <div id="notificationsList" class="space-y-3 mb-6">
                <!-- จะถูกเติมด้วย JavaScript -->
            </div>
            <div class="text-center">
                <button onclick="closeNotificationModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Modal การตั้งค่า -->
    <div id="settingsModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6 text-center flex items-center justify-center">
                <span class="text-3xl mr-2">⚙️</span>
                การตั้งค่า
            </h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="font-bold">เสียง</span>
                    <button onclick="toggleSound()" id="soundToggle" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-bold">เปิด</button>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-bold">ระดับเสียง</span>
                    <input type="range" id="volumeSlider" min="0" max="100" value="50" class="w-24">
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-bold">ลดการเคลื่อนไหว</span>
                    <button onclick="toggleMotion()" id="motionToggle" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-xl font-bold">ปิด</button>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-bold">ขนาดตัวอักษร</span>
                    <select id="fontSizeSelect" class="p-2 rounded-xl border-2 border-gray-200">
                        <option value="normal">ปกติ</option>
                        <option value="large">ใหญ่</option>
                        <option value="extra-large">ใหญ่มาก</option>
                    </select>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-bold">ความคมชัดสี</span>
                    <button onclick="toggleContrast()" id="contrastToggle" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-xl font-bold">ปกติ</button>
                </div>
            </div>
            <div class="text-center mt-6">
                <button onclick="closeSettingsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-bold">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Modal View-as-Student -->
    <div id="viewAsStudentModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <span class="text-3xl mr-2">👁️</span>
                    มุมมองนักเรียน (อ่านอย่างเดียว)
                </h3>
                <button onclick="closeViewAsStudentModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-bold">ปิด</button>
            </div>
            <div id="studentViewContent" class="text-center">
                <!-- จะถูกเติมด้วย JavaScript -->
            </div>
        </div>
    </div>

    <!-- Modal ยืนยันภารกิจ -->
    <div id="missionCompleteModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-4 text-center" id="missionCompleteTitle">ยืนยันการทำภารกิจสำเร็จ</h3>
            <div class="mb-6">
                <div id="missionCompleteInfo" class="text-center text-gray-700 mb-4"></div>
                <select id="missionCompleteStudentSelect" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                    <option value="">เลือกนักเรียน</option>
                    <option value="all">นักเรียนทั้งหมด</option>
                </select>
            </div>
            <div class="flex space-x-4">
                <button onclick="completeMission()" class="flex-1 btn-3d text-white py-3 rounded-xl font-bold">ให้รางวัล</button>
                <button onclick="closeMissionCompleteModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-bold">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Modal เปลี่ยนรูปต้นไม้ -->
    <div id="treeImageModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-2xl font-bold mb-6 text-center flex items-center justify-center">
                <span class="text-3xl mr-2">🎨</span>
                เปลี่ยนรูปต้นไม้สำหรับนักเรียน
            </h3>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">เลือกนักเรียน</label>
                <select id="treeImageStudentSelect" class="w-full p-4 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none text-lg">
                    <option value="">เลือกนักเรียน</option>
                    <option value="all">นักเรียนทั้งหมด</option>
                </select>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-gray-700 mb-4">เลือกประเภทต้นไม้ใหม่</label>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div onclick="selectNewTreeType('apple')" class="new-tree-selection glass-card p-4 rounded-xl text-center cursor-pointer border-2 border-transparent hover:border-red-400 transition-all">
                        <div class="text-4xl mb-2">🍎</div>
                        <div class="font-bold text-red-600 text-sm">ต้นแอปเปิ้ล</div>
                    </div>
                    <div onclick="selectNewTreeType('orange')" class="new-tree-selection glass-card p-4 rounded-xl text-center cursor-pointer border-2 border-transparent hover:border-orange-400 transition-all">
                        <div class="text-4xl mb-2">🍊</div>
                        <div class="font-bold text-orange-600 text-sm">ต้นส้ม</div>
                    </div>
                    <div onclick="selectNewTreeType('candy')" class="new-tree-selection glass-card p-4 rounded-xl text-center cursor-pointer border-2 border-transparent hover:border-pink-400 transition-all">
                        <div class="text-4xl mb-2">🍭</div>
                        <div class="font-bold text-pink-600 text-sm">ต้นลูกอม</div>
                    </div>
                    <div onclick="selectNewTreeType('donut')" class="new-tree-selection glass-card p-4 rounded-xl text-center cursor-pointer border-2 border-transparent hover:border-yellow-400 transition-all">
                        <div class="text-4xl mb-2">🍩</div>
                        <div class="font-bold text-yellow-600 text-sm">ต้นโดนัท</div>
                    </div>
                    <div onclick="selectNewTreeType('sweet')" class="new-tree-selection glass-card p-4 rounded-xl text-center cursor-pointer border-2 border-transparent hover:border-purple-400 transition-all">
                        <div class="text-4xl mb-2">🧁</div>
                        <div class="font-bold text-purple-600 text-sm">ต้นขนม</div>
                    </div>
                    <div onclick="selectNewTreeType('data')" class="new-tree-selection glass-card p-4 rounded-xl text-center cursor-pointer border-2 border-transparent hover:border-blue-400 transition-all">
                        <div class="text-4xl mb-2">💾</div>
                        <div class="font-bold text-blue-600 text-sm">ต้นข้อมูล</div>
                    </div>
                    <div onclick="selectNewTreeType('custom')" class="new-tree-selection glass-card p-4 rounded-xl text-center cursor-pointer border-2 border-transparent hover:border-green-400 transition-all">
                        <div class="text-4xl mb-2">📁</div>
                        <div class="font-bold text-green-600 text-sm">รูปภาพใหม่</div>
                    </div>
                </div>
                
                <!-- Custom Image Upload Section -->
                <div id="customImageSection" class="hidden mb-6 p-4 bg-green-50 rounded-xl border-2 border-green-200">
                    <h5 class="font-bold text-green-700 mb-3">อัปโหลดรูปภาพต้นไม้ใหม่</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">ชื่อต้นไม้</label>
                            <input type="text" id="customTreeName" placeholder="เช่น ต้นมะม่วง, ต้นกุหลาب" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">เลือกไฟล์รูปภาพ</label>
                            <input type="file" id="customTreeImage" accept="image/*" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none bg-white">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">หรือใส่ลิงก์รูปภาพ</label>
                            <input type="url" id="customTreeUrl" placeholder="https://example.com/tree-image.jpg" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none">
                        </div>
                        <div id="customTreePreview" class="hidden text-center p-4 bg-white rounded-xl border-2 border-gray-200">
                            <div class="text-sm text-gray-600 mb-2">ตัวอย่าง:</div>
                            <img id="previewImage" class="w-16 h-16 object-cover rounded-lg mx-auto" alt="Preview">
                            <div id="previewName" class="text-sm font-bold text-gray-700 mt-2"></div>
                        </div>
                        <button onclick="previewCustomTree()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-xl font-bold">ดูตัวอย่าง</button>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button onclick="applyTreeImageChange()" class="flex-1 btn-3d text-white py-3 rounded-xl font-bold">เปลี่ยนรูปต้นไม้</button>
                <button onclick="closeTreeImageModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-bold">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Modal โปรไฟล์ครู -->
    <div id="teacherProfileModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="glass-card rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold flex items-center">
                    <span class="text-3xl mr-2">👤</span>
                    โปรไฟล์ครู
                </h3>
                <button onclick="closeTeacherProfileModal()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-bold">ปิด</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                    <input type="text" id="profileFullName" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">อีเมล</label>
                    <input type="email" id="profileEmail" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ชื่อผู้ใช้</label>
                    <input type="text" id="profileUsername" class="w-full p-3 rounded-xl border-2 border-gray-200 bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">โรงเรียน/สถาบัน</label>
                    <input type="text" id="profileSchool" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">รหัสผ่านใหม่ (เว้นว่างหากไม่ต้องการเปลี่ยน)</label>
                    <input type="password" id="profileNewPassword" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">ยืนยันรหัสผ่านใหม่</label>
                    <input type="password" id="profileConfirmPassword" class="w-full p-3 rounded-xl border-2 border-gray-200 focus:border-green-500 outline-none">
                </div>
            </div>
            <div class="flex space-x-4 mt-6">
                <button onclick="updateTeacherProfile()" class="flex-1 btn-3d text-white py-3 rounded-xl font-bold">บันทึกการเปลี่ยนแปลง</button>
                <button onclick="closeTeacherProfileModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-xl font-bold">ยกเลิก</button>
            </div>
        </div>
    </div>

    <!-- Floating Notifications -->
    <div id="floatingNotifications" class="fixed top-4 right-4 space-y-2 z-40"></div>

    <script>
        // ข้อมูลเกม
        let gameData = {
            teachers: [], // เพิ่มข้อมูลครู
            classrooms: [],
            students: [],
            missions: [], // ภารกิจ
            announcements: [], // ประกาศ
            currentUser: null,
            currentStudent: null,
            selectedClassroom: null,
            selectedMission: null,
            wheelHistory: {}, // เก็บประวัติการหมุนวงล้อของแต่ละห้อง
            settings: {
                soundEnabled: true,
                volume: 50,
                reducedMotion: false,
                fontSize: 'normal',
                highContrast: false
            }
        };

        // ระดับต้นไม้
        const treeStages = [
            { name: 'เมล็ดพันธุ์', points: 0, emoji: '🌱', description: 'เมล็ดเล็ก ๆ ที่เต็มไปด้วยศักยภาพ', level: 1 },
            { name: 'หน่อออ่อน', points: 20, emoji: '🌿', description: 'สัญญาณแรกของการเติบโต!', level: 2 },
            { name: 'ต้นไม้เล็ก', points: 50, emoji: '🌳', description: 'เติบโตแข็งแรงขึ้นทุกวัน', level: 3 },
            { name: 'ต้นไม้กำลังโต', points: 100, emoji: '🌲', description: 'เอื้อมมือไปสู่ท้องฟ้า', level: 4 },
            { name: 'ต้นไม้เต็มตัว', points: 150, emoji: '🌴', description: 'แข็งแรงและสุขภาพดี', level: 5 },
            { name: 'ต้นไม้ 2 ดอก', points: 200, emoji: '🌸🌳', description: 'ดอกไม้สวยงามเริ่มผลิ', level: 6 },
            { name: 'ต้นไม้ 5 ดอก', points: 250, emoji: '🌸🌸🌳🌸🌸', description: 'บานสะพรั่งอย่างงดงาม', level: 7 },
            { name: 'ต้นไม้ 7 ดอก', points: 300, emoji: '🌸🌸🌸🌳🌸🌸🌸', description: 'การแสดงที่น่าตื่นตา', level: 8 },
            { name: 'ต้นไม้ 10 ดอก', points: 350, emoji: '🌸🌸🌸🌸🌳🌸🌸🌸🌸', description: 'ฤดูดอกไม้บานเต็มที่', level: 9 },
            { name: 'ต้นไม้ 2 ผล + ดอก', points: 400, emoji: '🍎🌸🌳🌸🍎', description: 'ผลแรกของการทำงานหนัก', level: 10 },
            { name: 'ต้นไม้ 5 ผล', points: 450, emoji: '🍎🍎🌳🍎🍎', description: 'การเก็บเกี่ยวที่อุดมสมบูรณ์เริ่มต้น', level: 11 },
            { name: 'ต้นไม้ 10 ผล', points: 500, emoji: '🍎🍎🍎🍎🌳🍎🍎🍎🍎', description: 'เจ้าแห่งการเรียนรู้! ต้นไม้เต็มที่แล้ว!', level: 12 }
        ];

        // ประเภทต้นไม้
        const treeTypes = {
            apple: { fruit: '🍎', color: 'text-red-500', name: 'แอปเปิ้ล' },
            orange: { fruit: '🍊', color: 'text-orange-500', name: 'ส้ม' },
            candy: { fruit: '🍭', color: 'text-pink-500', name: 'ลูกอม' },
            donut: { fruit: '🍩', color: 'text-yellow-500', name: 'โดนัท' },
            sweet: { fruit: '🧁', color: 'text-purple-500', name: 'ขนม' },
            data: { fruit: '💾', color: 'text-blue-500', name: 'ข้อมูล' }
        };

        // Custom tree types (จะถูกเพิ่มแบบไดนามิก)
        let customTreeTypes = {};

        // การกระทำ
        const actions = {
            water: { points: 10, effect: 'water', message: 'ครูรดน้ำให้ต้นไม้ของคุณ! 💧 (+10 คะแนน)', title: 'รดน้ำ' },
            fertilizer: { points: 20, effect: 'fertilizer', message: 'ครูใส่ปุ๋ยให้ต้นไม้ของคุณ! 🌱 (+20 คะแนน)', title: 'ใส่ปุ๋ย' },
            rain: { points: 30, effect: 'rain', message: 'ฝนตกให้ต้นไม้ของคุณ! 🌧️ (+30 คะแนน)', title: 'ฝนตก' },
            worm: { points: -10, effect: 'worm', message: 'หนอนมากัดต้นไม้! 🐛 (-10 คะแนน)', title: 'หนอนกัด' },
            sick: { points: -20, effect: 'sick', message: 'ต้นไม้ป่วย! 🤒 (-20 คะแนน)', title: 'ต้นไม้ป่วย' },
            storm: { points: -30, effect: 'storm', message: 'พายุโจมตีต้นไม้! ⛈️ (-30 คะแนน)', title: 'พายุ' }
        };

        let currentAction = null;
        let selectedNewTreeType = null;

        // โหลดข้อมูลจาก localStorage
        function loadData() {
            const saved = localStorage.getItem('tree-garden-data');
            if (saved) {
                gameData = JSON.parse(saved);
                // โหลด custom tree types
                if (gameData.customTreeTypes) {
                    customTreeTypes = gameData.customTreeTypes;
                }
            }
        }

        // บันทึกข้อมูลลง localStorage
        function saveData() {
            localStorage.setItem('tree-garden-data', JSON.stringify(gameData));
        }

        // เริ่มต้น
        loadData();
        
        // สร้างบัญชีครูตัวอย่าง (เฉพาะครั้งแรก)
        if (gameData.teachers.length === 0) {
            const demoTeacher = {
                id: 1,
                fullName: 'ครูสมชาย ใจดี',
                email: 'teacher@demo.com',
                username: 'teacher',
                password: '123456',
                school: 'โรงเรียนตัวอย่าง',
                createdAt: new Date().toISOString(),
                classrooms: []
            };
            gameData.teachers.push(demoTeacher);
            saveData();
        }

        function showLogin(type) {
            document.getElementById('loginScreen').classList.add('hidden');
            if (type === 'teacher') {
                document.getElementById('teacherLogin').classList.remove('hidden');
            } else {
                document.getElementById('studentLogin').classList.remove('hidden');
            }
        }

        function backToMain() {
            document.getElementById('teacherLogin').classList.add('hidden');
            document.getElementById('studentLogin').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function teacherLogin() {
            const username = document.getElementById('teacherUsername').value.trim();
            const password = document.getElementById('teacherPassword').value;
            
            if (!username || !password) {
                alert('กรุณากรอกชื่อผู้ใช้และรหัสผ่าน');
                return;
            }
            
            // ตรวจสอบข้อมูลครู
            const teacher = gameData.teachers.find(t => t.username === username && t.password === password);
            
            if (teacher) {
                gameData.currentUser = { 
                    type: 'teacher', 
                    username: teacher.username,
                    fullName: teacher.fullName,
                    email: teacher.email,
                    school: teacher.school,
                    id: teacher.id
                };
                saveData();
                showTeacherDashboard();
                
                // ล้างฟอร์ม
                document.getElementById('teacherUsername').value = '';
                document.getElementById('teacherPassword').value = '';
            } else {
                alert('ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง');
            }
        }

        function showTeacherRegister() {
            document.getElementById('teacherLogin').classList.add('hidden');
            document.getElementById('teacherRegister').classList.remove('hidden');
        }

        function showTeacherLogin() {
            document.getElementById('teacherRegister').classList.add('hidden');
            document.getElementById('forgotPassword').classList.add('hidden');
            document.getElementById('teacherLogin').classList.remove('hidden');
        }

        function showForgotPassword() {
            document.getElementById('teacherLogin').classList.add('hidden');
            document.getElementById('forgotPassword').classList.remove('hidden');
        }

        function teacherRegister() {
            const fullName = document.getElementById('registerFullName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const school = document.getElementById('registerSchool').value.trim();

            // ตรวจสอบข้อมูล
            if (!fullName || !email || !username || !password || !confirmPassword || !school) {
                alert('กรุณากรอกข้อมูลให้ครบทุกช่อง');
                return;
            }

            // ตรวจสอบรูปแบบอีเมล
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('รูปแบบอีเมลไม่ถูกต้อง');
                return;
            }

            // ตรวจสอบชื่อผู้ใช้ (ภาษาอังกฤษเท่านั้น)
            const usernameRegex = /^[a-zA-Z0-9_]+$/;
            if (!usernameRegex.test(username)) {
                alert('ชื่อผู้ใช้ต้องเป็นภาษาอังกฤษ ตัวเลข และ _ เท่านั้น');
                return;
            }

            // ตรวจสอบความยาวรหัสผ่าน
            if (password.length < 6) {
                alert('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }

            // ตรวจสอบการยืนยันรหัสผ่าน
            if (password !== confirmPassword) {
                alert('รหัสผ่านและการยืนยันรหัสผ่านไม่ตรงกัน');
                return;
            }

            // ตรวจสอบว่าชื่อผู้ใช้หรืออีเมลซ้ำหรือไม่
            const existingTeacher = gameData.teachers.find(t => t.username === username || t.email === email);
            if (existingTeacher) {
                alert('ชื่อผู้ใช้หรืออีเมลนี้มีอยู่ในระบบแล้ว');
                return;
            }

            // สร้างบัญชีครูใหม่
            const newTeacher = {
                id: Date.now(),
                fullName: fullName,
                email: email,
                username: username,
                password: password, // ในระบบจริงควรเข้ารหัส
                school: school,
                createdAt: new Date().toISOString(),
                classrooms: []
            };

            gameData.teachers.push(newTeacher);
            saveData();

            alert('สร้างบัญชีสำเร็จ! กรุณาเข้าสู่ระบบ');
            
            // ล้างฟอร์มและกลับไปหน้าเข้าสู่ระบบ
            document.getElementById('registerFullName').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerUsername').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerConfirmPassword').value = '';
            document.getElementById('registerSchool').value = '';
            
            showTeacherLogin();
        }

        function resetPassword() {
            const username = document.getElementById('forgotUsername').value.trim();
            
            if (!username) {
                alert('กรุณากรอกชื่อผู้ใช้');
                return;
            }

            const teacher = gameData.teachers.find(t => t.username === username);
            
            if (teacher) {
                // สร้างรหัสผ่านใหม่แบบสุ่ม
                const newPassword = Math.random().toString(36).slice(-8);
                teacher.password = newPassword;
                saveData();

                alert(`รีเซ็ตรหัสผ่านสำเร็จ!\n\nรหัสผ่านใหม่: ${newPassword}\n\nกรุณาบันทึกรหัสผ่านนี้และเปลี่ยนรหัสผ่านใหม่หลังจากเข้าสู่ระบบ\n\n(ในระบบจริงจะส่งทางอีเมล)`);
                
                document.getElementById('forgotUsername').value = '';
                showTeacherLogin();
            } else {
                alert('ไม่พบชื่อผู้ใช้นี้ในระบบ');
            }
        }

        function studentLogin() {
            const code = document.getElementById('studentCode').value.toUpperCase();
            
            if (code) {
                const student = gameData.students.find(s => s.code === code);
                if (student) {
                    gameData.currentStudent = student;
                    saveData();
                    showStudentDashboard();
                } else {
                    alert('รหัสนักเรียนไม่ถูกต้อง กรุณาตรวจสอบกับครู');
                }
            }
        }

        function logout() {
            gameData.currentUser = null;
            gameData.currentStudent = null;
            gameData.selectedClassroom = null;
            saveData();
            document.getElementById('teacherDashboard').classList.add('hidden');
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showTeacherDashboard() {
            document.getElementById('teacherLogin').classList.add('hidden');
            document.getElementById('teacherDashboard').classList.remove('hidden');
            updateTeacherDashboard();
            updateTeacherHeader();
        }

        function updateTeacherHeader() {
            if (gameData.currentUser && gameData.currentUser.type === 'teacher') {
                document.getElementById('teacherNameDisplay').textContent = gameData.currentUser.fullName || gameData.currentUser.username;
                document.getElementById('teacherSchoolDisplay').textContent = gameData.currentUser.school || '';
                document.getElementById('teacherWelcomeText').textContent = `ยินดีต้อนรับ, ${gameData.currentUser.fullName || gameData.currentUser.username}!`;
            }
        }

        function showTeacherProfile() {
            if (!gameData.currentUser || gameData.currentUser.type !== 'teacher') return;
            
            const teacher = gameData.teachers.find(t => t.id === gameData.currentUser.id);
            if (!teacher) return;
            
            document.getElementById('profileFullName').value = teacher.fullName;
            document.getElementById('profileEmail').value = teacher.email;
            document.getElementById('profileUsername').value = teacher.username;
            document.getElementById('profileSchool').value = teacher.school;
            document.getElementById('profileNewPassword').value = '';
            document.getElementById('profileConfirmPassword').value = '';
            
            document.getElementById('teacherProfileModal').classList.remove('hidden');
        }

        function closeTeacherProfileModal() {
            document.getElementById('teacherProfileModal').classList.add('hidden');
        }

        function updateTeacherProfile() {
            if (!gameData.currentUser || gameData.currentUser.type !== 'teacher') return;
            
            const teacher = gameData.teachers.find(t => t.id === gameData.currentUser.id);
            if (!teacher) return;
            
            const fullName = document.getElementById('profileFullName').value.trim();
            const email = document.getElementById('profileEmail').value.trim();
            const school = document.getElementById('profileSchool').value.trim();
            const newPassword = document.getElementById('profileNewPassword').value;
            const confirmPassword = document.getElementById('profileConfirmPassword').value;
            
            // ตรวจสอบข้อมูลพื้นฐาน
            if (!fullName || !email || !school) {
                alert('กรุณากรอกข้อมูลให้ครบทุกช่อง');
                return;
            }
            
            // ตรวจสอบรูปแบบอีเมล
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('รูปแบบอีเมลไม่ถูกต้อง');
                return;
            }
            
            // ตรวจสอบอีเมลซ้ำ (ยกเว้นตัวเอง)
            const existingTeacher = gameData.teachers.find(t => t.email === email && t.id !== teacher.id);
            if (existingTeacher) {
                alert('อีเมลนี้มีอยู่ในระบบแล้ว');
                return;
            }
            
            // ตรวจสอบรหัสผ่านใหม่ (ถ้ามี)
            if (newPassword) {
                if (newPassword.length < 6) {
                    alert('รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('รหัสผ่านและการยืนยันรหัสผ่านไม่ตรงกัน');
                    return;
                }
                
                teacher.password = newPassword;
            }
            
            // อัปเดตข้อมูล
            teacher.fullName = fullName;
            teacher.email = email;
            teacher.school = school;
            teacher.updatedAt = new Date().toISOString();
            
            // อัปเดตข้อมูลผู้ใช้ปัจจุบัน
            gameData.currentUser.fullName = fullName;
            gameData.currentUser.email = email;
            gameData.currentUser.school = school;
            
            saveData();
            updateTeacherHeader();
            closeTeacherProfileModal();
            
            alert('อัปเดตโปรไฟล์สำเร็จ!');
        }

        function showStudentDashboard() {
            document.getElementById('studentLogin').classList.add('hidden');
            document.getElementById('studentDashboard').classList.remove('hidden');
            updateStudentDashboard();
        }

        function createClassroom() {
            const name = document.getElementById('classroomName').value.trim();
            if (!name) {
                alert('กรุณากรอกชื่อห้องเรียน');
                return;
            }
            
            if (!gameData.currentUser || gameData.currentUser.type !== 'teacher') {
                alert('เฉพาะครูเท่านั้นที่สามารถสร้างห้องเรียนได้');
                return;
            }
            
            const classroom = {
                id: Date.now(),
                name: name,
                teacherId: gameData.currentUser.id,
                students: [],
                createdAt: new Date().toISOString()
            };
            
            gameData.classrooms.push(classroom);
            
            // เพิ่มห้องเรียนให้กับครู
            const teacher = gameData.teachers.find(t => t.id === gameData.currentUser.id);
            if (teacher) {
                if (!teacher.classrooms) teacher.classrooms = [];
                teacher.classrooms.push(classroom.id);
            }
            
            document.getElementById('classroomName').value = '';
            saveData();
            updateTeacherDashboard();
        }

        function selectClassroom(classroomId) {
            gameData.selectedClassroom = classroomId;
            updateTeacherDashboard();
        }

        function addStudents() {
            const classroomId = parseInt(document.getElementById('classroomSelect').value);
            const names = document.getElementById('studentNames').value.split('\n').filter(n => n.trim());
            
            if (classroomId && names.length > 0) {
                const classroom = gameData.classrooms.find(c => c.id === classroomId);
                
                names.forEach(name => {
                    const student = {
                        id: Date.now() + Math.random(),
                        name: name.trim(),
                        code: generateStudentCode(),
                        classroomId: classroomId,
                        points: 0,
                        treeType: null,
                        notifications: [],
                        garden: [], // เก็บต้นไม้ที่เสร็จแล้ว
                        needsTreeSelection: false // ต้องเลือกต้นไม้ใหม่หรือไม่
                    };
                    gameData.students.push(student);
                    classroom.students.push(student.id);
                });
                
                document.getElementById('studentNames').value = '';
                saveData();
                updateTeacherDashboard();
            }
        }

        function generateStudentCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function createMission() {
            const title = document.getElementById('missionTitle').value.trim();
            const description = document.getElementById('missionDescription').value.trim();
            const reward = parseInt(document.getElementById('missionReward').value);
            
            if (!title || !description || !reward || reward <= 0) {
                alert('กรุณากรอกข้อมูลภารกิจให้ครบถ้วน');
                return;
            }
            
            if (!gameData.selectedClassroom) {
                alert('กรุณาเลือกห้องเรียนก่อน');
                return;
            }
            
            const mission = {
                id: Date.now(),
                title: title,
                description: description,
                reward: reward,
                classroomId: gameData.selectedClassroom,
                teacherId: gameData.currentUser.id,
                createdAt: new Date().toISOString(),
                active: true
            };
            
            gameData.missions.push(mission);
            
            // ส่งการแจ้งเตือนให้นักเรียนในห้องเรียน
            const students = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            students.forEach(student => {
                const notification = {
                    id: Date.now() + Math.random(),
                    message: `🎯 ภารกิจใหม่: "${title}" - รางวัล ${reward} คะแนน!`,
                    effect: 'mission',
                    timestamp: new Date().toISOString(),
                    viewed: false,
                    missionId: mission.id
                };
                student.notifications.push(notification);
            });
            
            // ล้างฟอร์ม
            document.getElementById('missionTitle').value = '';
            document.getElementById('missionDescription').value = '';
            document.getElementById('missionReward').value = '';
            
            saveData();
            updateTeacherDashboard();
            alert(`สร้างภารกิจ "${title}" สำเร็จ! ส่งแจ้งเตือนให้นักเรียน ${students.length} คนแล้ว`);
        }

        function createAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const message = document.getElementById('announcementMessage').value.trim();
            
            if (!title || !message) {
                alert('กรุณากรอกหัวข้อและข้อความประกาศ');
                return;
            }
            
            if (!gameData.selectedClassroom) {
                alert('กรุณาเลือกห้องเรียนก่อน');
                return;
            }
            
            const announcement = {
                id: Date.now(),
                title: title,
                message: message,
                classroomId: gameData.selectedClassroom,
                teacherId: gameData.currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            gameData.announcements.push(announcement);
            
            // ส่งการแจ้งเตือนให้นักเรียนในห้องเรียน
            const students = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            students.forEach(student => {
                const notification = {
                    id: Date.now() + Math.random(),
                    message: `📢 ประกาศ: "${title}" - ${message}`,
                    effect: 'announcement',
                    timestamp: new Date().toISOString(),
                    viewed: false
                };
                student.notifications.push(notification);
            });
            
            // ล้างฟอร์ม
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementMessage').value = '';
            
            saveData();
            alert(`ส่งประกาศ "${title}" สำเร็จ! ส่งแจ้งเตือนให้นักเรียน ${students.length} คนแล้ว`);
        }

        function updateTeacherDashboard() {
            // อัปเดตรายการห้องเรียน (เฉพาะของครูที่เข้าสู่ระบบ)
            const classroomsList = document.getElementById('classroomsList');
            classroomsList.innerHTML = '';
            
            const teacherClassrooms = gameData.classrooms.filter(c => c.teacherId === gameData.currentUser?.id);
            
            if (teacherClassrooms.length === 0) {
                classroomsList.innerHTML = '<div class="text-center text-gray-500 py-4">ยังไม่มีห้องเรียน<br>สร้างห้องเรียนแรกของคุณ!</div>';
            } else {
                teacherClassrooms.forEach(classroom => {
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-xl cursor-pointer transition-all ${
                        gameData.selectedClassroom === classroom.id 
                            ? 'bg-green-500 text-white' 
                            : 'bg-white hover:bg-green-50'
                    }`;
                    div.innerHTML = `
                        <div class="font-bold">${classroom.name}</div>
                        <div class="text-sm opacity-75">${classroom.students.length} นักเรียน</div>
                        <div class="text-xs opacity-60">${new Date(classroom.createdAt).toLocaleDateString('th-TH')}</div>
                    `;
                    div.onclick = () => selectClassroom(classroom.id);
                    classroomsList.appendChild(div);
                });
            }

            // อัปเดต select ห้องเรียน (เฉพาะของครูที่เข้าสู่ระบบ)
            const classroomSelect = document.getElementById('classroomSelect');
            classroomSelect.innerHTML = '<option value="">เลือกห้องเรียน</option>';
            teacherClassrooms.forEach(classroom => {
                const option = document.createElement('option');
                option.value = classroom.id;
                option.textContent = classroom.name;
                classroomSelect.appendChild(option);
            });

            // อัปเดตกริดนักเรียน
            updateStudentsGrid();
            
            // อัปเดตรายการภารกิจ
            updateMissionsList();
        }

        function updateMissionsList() {
            const missionsList = document.getElementById('teacherMissionsList');
            if (!missionsList) return;
            
            missionsList.innerHTML = '';
            
            if (!gameData.selectedClassroom) {
                missionsList.innerHTML = '<div class="text-center text-gray-500 py-2">เลือกห้องเรียนเพื่อดูภารกิจ</div>';
                return;
            }
            
            const missions = gameData.missions.filter(m => m.classroomId === gameData.selectedClassroom && m.active);
            
            if (missions.length === 0) {
                missionsList.innerHTML = '<div class="text-center text-gray-500 py-2">ยังไม่มีภารกิจ</div>';
                return;
            }
            
            missions.forEach(mission => {
                const div = document.createElement('div');
                div.className = 'bg-orange-50 p-3 rounded-xl border border-orange-200';
                div.innerHTML = `
                    <div class="font-bold text-orange-800">${mission.title}</div>
                    <div class="text-sm text-orange-600 mb-2">${mission.description}</div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold text-green-600">รางวัล: ${mission.reward} คะแนน</span>
                        <button onclick="showMissionCompleteModal(${mission.id})" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg text-xs font-bold">
                            ✅ ให้รางวัล
                        </button>
                    </div>
                `;
                missionsList.appendChild(div);
            });
        }

        function updateStudentsGrid() {
            const studentsGrid = document.getElementById('studentsGrid');
            const selectedClassroomName = document.getElementById('selectedClassroomName');
            
            if (!gameData.selectedClassroom) {
                studentsGrid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">เลือกห้องเรียนเพื่อดูนักเรียน</div>';
                selectedClassroomName.textContent = '';
                return;
            }

            const classroom = gameData.classrooms.find(c => c.id === gameData.selectedClassroom);
            selectedClassroomName.textContent = `- ${classroom.name}`;
            
            const students = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            
            if (students.length === 0) {
                studentsGrid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">ยังไม่มีนักเรียนในห้องนี้</div>';
                return;
            }

            studentsGrid.innerHTML = '';
            students.forEach(student => {
                const stage = getCurrentStage(student.points);
                const div = document.createElement('div');
                div.className = 'student-card p-4 rounded-xl';
                const treeDisplayHTML = getTreeDisplay(student);
                const treeTypeName = student.treeType ? 
                    (customTreeTypes[student.treeType] ? customTreeTypes[student.treeType].name : treeTypes[student.treeType]?.name) : '';
                
                div.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-2 tree-3d">${treeDisplayHTML}</div>
                        <div class="font-bold text-gray-800">${student.name}</div>
                        <div class="text-sm text-gray-600">รหัส: ${student.code}</div>
                        <div class="text-sm text-green-600 font-bold">${student.points} คะแนน</div>
                        <div class="text-xs text-gray-500">${stage.name}</div>
                        ${treeTypeName ? `<div class="text-xs text-blue-500">${treeTypeName}</div>` : ''}
                        <button onclick="viewAsStudent('${student.id}')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold">
                            👁️ ดูแบบนักเรียน
                        </button>
                    </div>
                `;
                studentsGrid.appendChild(div);
            });

            // อัปเดต select นักเรียนในการกระทำ
            updateActionStudentSelect();
            
            // อัปเดตกระดานอันดับ
            updateClassPositionBoard();
        }

        function updateActionStudentSelect() {
            const select = document.getElementById('actionStudentSelect');
            select.innerHTML = '<option value="">เลือกนักเรียน</option><option value="all">นักเรียนทั้งหมด</option>';
            
            if (gameData.selectedClassroom) {
                const students = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            }
            
            // อัปเดต select สำหรับเปลี่ยนรูปต้นไม้ด้วย
            updateTreeImageStudentSelect();
        }

        function updateTreeImageStudentSelect() {
            const select = document.getElementById('treeImageStudentSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">เลือกนักเรียน</option><option value="all">นักเรียนทั้งหมด</option>';
            
            if (gameData.selectedClassroom) {
                const students = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    const treeTypeName = student.treeType ? 
                        (customTreeTypes[student.treeType] ? customTreeTypes[student.treeType].name : treeTypes[student.treeType]?.name || 'ไม่ทราบ') : 
                        'ยังไม่เลือก';
                    option.textContent = `${student.name} (${treeTypeName})`;
                    select.appendChild(option);
                });
            }
        }

        function showTreeImageModal() {
            if (!gameData.selectedClassroom) {
                alert('กรุณาเลือกห้องเรียนก่อน');
                return;
            }
            
            selectedNewTreeType = null;
            document.querySelectorAll('.new-tree-selection').forEach(el => {
                el.classList.remove('border-green-500', 'bg-green-50');
            });
            
            updateTreeImageStudentSelect();
            document.getElementById('treeImageModal').classList.remove('hidden');
        }

        function closeTreeImageModal() {
            document.getElementById('treeImageModal').classList.add('hidden');
            selectedNewTreeType = null;
        }

        function selectNewTreeType(type) {
            selectedNewTreeType = type;
            
            // อัปเดต UI
            document.querySelectorAll('.new-tree-selection').forEach(el => {
                el.classList.remove('border-green-500', 'bg-green-50');
            });
            
            event.target.closest('.new-tree-selection').classList.add('border-green-500', 'bg-green-50');
            
            // แสดง/ซ่อนส่วนอัปโหลดรูปภาพ
            const customSection = document.getElementById('customImageSection');
            if (type === 'custom') {
                customSection.classList.remove('hidden');
                setupCustomTreeUpload();
            } else {
                customSection.classList.add('hidden');
                document.getElementById('customTreePreview').classList.add('hidden');
            }
        }
        
        function setupCustomTreeUpload() {
            // สร้างฟิลด์อัปโหลดสำหรับแต่ละระดับ
            const stageUploads = document.getElementById('stageUploads');
            const stageUrls = document.getElementById('stageUrls');
            
            stageUploads.innerHTML = '';
            stageUrls.innerHTML = '';
            
            treeStages.forEach((stage, index) => {
                // สร้างฟิลด์อัปโหลดไฟล์
                const fileDiv = document.createElement('div');
                fileDiv.className = 'bg-white p-3 rounded-lg border border-gray-200';
                fileDiv.innerHTML = `
                    <div class="text-sm font-bold text-gray-700 mb-2">
                        ${stage.emoji} ระดับ ${index + 1}: ${stage.name}
                    </div>
                    <input type="file" id="stageFile_${index}" accept="image/*" class="w-full text-xs p-2 border border-gray-200 rounded">
                `;
                stageUploads.appendChild(fileDiv);
                
                // สร้างฟิลด์ URL
                const urlDiv = document.createElement('div');
                urlDiv.className = 'bg-white p-3 rounded-lg border border-gray-200';
                urlDiv.innerHTML = `
                    <div class="text-sm font-bold text-gray-700 mb-2">
                        ${stage.emoji} ระดับ ${index + 1}: ${stage.name}
                    </div>
                    <input type="url" id="stageUrl_${index}" placeholder="https://example.com/stage${index + 1}.jpg" class="w-full text-sm p-2 border border-gray-200 rounded">
                `;
                stageUrls.appendChild(urlDiv);
            });
            
            // จัดการการเปลี่ยนวิธีอัปโหลด
            document.querySelectorAll('input[name="uploadMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'files') {
                        document.getElementById('fileUploadSection').classList.remove('hidden');
                        document.getElementById('urlUploadSection').classList.add('hidden');
                    } else {
                        document.getElementById('fileUploadSection').classList.add('hidden');
                        document.getElementById('urlUploadSection').classList.remove('hidden');
                    }
                });
            });
        }

        function previewCustomTree() {
            const name = document.getElementById('customTreeName').value.trim();
            
            if (!name) {
                alert('กรุณาใส่ชื่อต้นไม้');
                return;
            }
            
            const uploadMethod = document.querySelector('input[name="uploadMethod"]:checked').value;
            const preview = document.getElementById('customTreePreview');
            const previewName = document.getElementById('previewName');
            const previewStages = document.getElementById('previewStages');
            
            previewName.textContent = name;
            previewStages.innerHTML = '';
            
            let hasImages = false;
            
            if (uploadMethod === 'files') {
                // ตรวจสอบไฟล์
                for (let i = 0; i < treeStages.length; i++) {
                    const fileInput = document.getElementById(`stageFile_${i}`);
                    if (fileInput && fileInput.files && fileInput.files[0]) {
                        hasImages = true;
                        const file = fileInput.files[0];
                        
                        // ตรวจสอบประเภทไฟล์
                        if (!file.type.startsWith('image/')) {
                            alert(`ไฟล์ระดับ ${i + 1} ไม่ใช่รูปภาพ`);
                            return;
                        }
                        
                        // ตรวจสอบขนาดไฟล์ (ไม่เกิน 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            alert(`ไฟล์ระดับ ${i + 1} มีขนาดเกิน 5MB`);
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const stageDiv = document.createElement('div');
                            stageDiv.className = 'text-center';
                            stageDiv.innerHTML = `
                                <img src="${e.target.result}" class="w-12 h-12 object-cover rounded mx-auto mb-1" alt="ระดับ ${i + 1}">
                                <div class="text-xs text-gray-600">Lv.${i + 1}</div>
                            `;
                            previewStages.appendChild(stageDiv);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // แสดง placeholder สำหรับระดับที่ไม่มีรูป
                        const stageDiv = document.createElement('div');
                        stageDiv.className = 'text-center';
                        stageDiv.innerHTML = `
                            <div class="w-12 h-12 bg-gray-200 rounded mx-auto mb-1 flex items-center justify-center text-gray-400 text-xs">
                                ไม่มีรูป
                            </div>
                            <div class="text-xs text-gray-600">Lv.${i + 1}</div>
                        `;
                        previewStages.appendChild(stageDiv);
                    }
                }
            } else {
                // ตรวจสอบ URL
                for (let i = 0; i < treeStages.length; i++) {
                    const urlInput = document.getElementById(`stageUrl_${i}`);
                    if (urlInput && urlInput.value.trim()) {
                        hasImages = true;
                        try {
                            new URL(urlInput.value.trim());
                            const stageDiv = document.createElement('div');
                            stageDiv.className = 'text-center';
                            stageDiv.innerHTML = `
                                <img src="${urlInput.value.trim()}" class="w-12 h-12 object-cover rounded mx-auto mb-1" alt="ระดับ ${i + 1}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAzNkMzMC42Mjc0IDM2IDM2IDMwLjYyNzQgMzYgMjRDMzYgMTcuMzcyNiAzMC42Mjc0IDEyIDI0IDEyQzE3LjM3MjYgMTIgMTIgMTcuMzcyNiAxMiAyNEMxMiAzMC42Mjc0IDE3LjM3MjYgMzYgMjQgMzZaIiBzdHJva2U9IiM5Q0EzQUYiIHN0cm9rZS13aWR0aD0iMiIvPgo8cGF0aCBkPSJNMjEgMjFMMjcgMjciIHN0cm9rZT0iIzlDQTNBRiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPHA+PC9wYXRoPgo8L3N2Zz4K'; this.alt='ไม่สามารถโหลดรูปได้';">
                                <div class="text-xs text-gray-600">Lv.${i + 1}</div>
                            `;
                            previewStages.appendChild(stageDiv);
                        } catch (e) {
                            alert(`URL ระดับ ${i + 1} ไม่ถูกต้อง`);
                            return;
                        }
                    } else {
                        // แสดง placeholder สำหรับระดับที่ไม่มี URL
                        const stageDiv = document.createElement('div');
                        stageDiv.className = 'text-center';
                        stageDiv.innerHTML = `
                            <div class="w-12 h-12 bg-gray-200 rounded mx-auto mb-1 flex items-center justify-center text-gray-400 text-xs">
                                ไม่มี URL
                            </div>
                            <div class="text-xs text-gray-600">Lv.${i + 1}</div>
                        `;
                        previewStages.appendChild(stageDiv);
                    }
                }
            }
            
            if (!hasImages) {
                alert('กรุณาอัปโหลดรูปภาพอย่างน้อย 1 ระดับ');
                return;
            }
            
            preview.classList.remove('hidden');
        }
        
        function clearCustomTree() {
            document.getElementById('customTreeName').value = '';
            document.getElementById('customTreePreview').classList.add('hidden');
            
            // ล้างไฟล์
            treeStages.forEach((stage, index) => {
                const fileInput = document.getElementById(`stageFile_${index}`);
                const urlInput = document.getElementById(`stageUrl_${index}`);
                if (fileInput) fileInput.value = '';
                if (urlInput) urlInput.value = '';
            });
        }

        function createCustomTreeType() {
            const name = document.getElementById('customTreeName').value.trim();
            
            if (!name) {
                alert('กรุณาใส่ชื่อต้นไม้');
                return null;
            }
            
            const uploadMethod = document.querySelector('input[name="uploadMethod"]:checked').value;
            const stageImages = [];
            
            if (uploadMethod === 'files') {
                // ประมวลผลไฟล์
                const promises = [];
                
                for (let i = 0; i < treeStages.length; i++) {
                    const fileInput = document.getElementById(`stageFile_${i}`);
                    if (fileInput && fileInput.files && fileInput.files[0]) {
                        const file = fileInput.files[0];
                        const promise = new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                resolve({ index: i, data: e.target.result });
                            };
                            reader.readAsDataURL(file);
                        });
                        promises.push(promise);
                    }
                }
                
                if (promises.length === 0) {
                    alert('กรุณาอัปโหลดรูปภาพอย่างน้อย 1 ระดับ');
                    return null;
                }
                
                return Promise.all(promises).then(results => {
                    // สร้าง array สำหรับเก็บรูปภาพแต่ละระดับ
                    const stageImages = new Array(treeStages.length).fill(null);
                    
                    results.forEach(result => {
                        stageImages[result.index] = result.data;
                    });
                    
                    const customId = 'custom_' + Date.now();
                    customTreeTypes[customId] = {
                        fruit: '🌳', // fallback
                        color: 'text-green-500',
                        name: name,
                        isCustom: true,
                        stageImages: stageImages
                    };
                    
                    return customId;
                });
                
            } else {
                // ประมวลผล URL
                const stageImages = new Array(treeStages.length).fill(null);
                let hasImages = false;
                
                for (let i = 0; i < treeStages.length; i++) {
                    const urlInput = document.getElementById(`stageUrl_${i}`);
                    if (urlInput && urlInput.value.trim()) {
                        stageImages[i] = urlInput.value.trim();
                        hasImages = true;
                    }
                }
                
                if (!hasImages) {
                    alert('กรุณาใส่ URL รูปภาพอย่างน้อย 1 ระดับ');
                    return null;
                }
                
                const customId = 'custom_' + Date.now();
                customTreeTypes[customId] = {
                    fruit: '🌳', // fallback
                    color: 'text-green-500',
                    name: name,
                    isCustom: true,
                    stageImages: stageImages
                };
                
                return Promise.resolve(customId);
            }
        }

        async function applyTreeImageChange() {
            const studentId = document.getElementById('treeImageStudentSelect').value;
            
            if (!studentId || !selectedNewTreeType) {
                alert('กรุณาเลือกนักเรียนและประเภทต้นไม้');
                return;
            }
            
            let finalTreeType = selectedNewTreeType;
            
            // ถ้าเป็น custom tree ให้สร้างก่อน
            if (selectedNewTreeType === 'custom') {
                const customTreeId = await createCustomTreeType();
                if (!customTreeId) {
                    alert('ไม่สามารถสร้างต้นไม้ใหม่ได้');
                    return;
                }
                finalTreeType = customTreeId;
            }
            
            let targetStudents = [];
            
            if (studentId === 'all') {
                targetStudents = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            } else {
                const student = gameData.students.find(s => s.id == studentId);
                if (student) targetStudents = [student];
            }
            
            targetStudents.forEach(student => {
                const oldTreeType = student.treeType;
                student.treeType = finalTreeType;
                
                // หาชื่อต้นไม้
                const treeTypeName = customTreeTypes[finalTreeType] ? 
                    customTreeTypes[finalTreeType].name : 
                    treeTypes[finalTreeType].name;
                
                // ส่งการแจ้งเตือนให้นักเรียน
                const notification = {
                    id: Date.now() + Math.random(),
                    message: `🎨 ครูเปลี่ยนต้นไม้ของคุณเป็น${treeTypeName}แล้ว!`,
                    effect: 'tree_change',
                    timestamp: new Date().toISOString(),
                    viewed: false
                };
                student.notifications.push(notification);
            });
            
            // บันทึก custom tree types
            gameData.customTreeTypes = customTreeTypes;
            saveData();
            updateStudentsGrid();
            closeTreeImageModal();
            
            const treeTypeName = customTreeTypes[finalTreeType] ? 
                customTreeTypes[finalTreeType].name : 
                treeTypes[finalTreeType].name;
            alert(`เปลี่ยนต้นไม้เป็น${treeTypeName}สำหรับ ${targetStudents.length} คน สำเร็จ!`);
        }

        function updateClassPositionBoard() {
            const positionBoard = document.getElementById('classPositionBoard');
            
            if (!gameData.selectedClassroom) {
                positionBoard.innerHTML = '<div class="text-center text-gray-500 py-4">เลือกห้องเรียนเพื่อดูอันดับ</div>';
                return;
            }
            
            const students = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            
            if (students.length === 0) {
                positionBoard.innerHTML = '<div class="text-center text-gray-500 py-4">ยังไม่มีนักเรียนในห้องนี้</div>';
                return;
            }
            
            // เรียงลำดับตามคะแนน
            const sortedStudents = students.sort((a, b) => b.points - a.points);
            
            positionBoard.innerHTML = '';
            
            sortedStudents.forEach((student, index) => {
                const stage = getCurrentStage(student.points);
                const position = index + 1;
                
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-lg mb-2 ${
                    position === 1 ? 'bg-gradient-to-r from-yellow-200 to-yellow-300 border-2 border-yellow-400' :
                    position === 2 ? 'bg-gradient-to-r from-gray-200 to-gray-300 border-2 border-gray-400' :
                    position === 3 ? 'bg-gradient-to-r from-orange-200 to-orange-300 border-2 border-orange-400' :
                    'bg-white border border-gray-200'
                }`;
                
                const rankEmoji = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : `#${position}`;
                
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="text-lg font-bold ${position <= 3 ? 'text-2xl' : 'text-gray-600'}">${rankEmoji}</div>
                        <div>
                            <div class="font-bold text-gray-800">${student.name}</div>
                            <div class="text-sm text-gray-600">Lv.${treeStages.indexOf(stage) + 1} - ${stage.name}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-green-600">${student.points}</div>
                        <div class="text-xs text-gray-500">คะแนน</div>
                    </div>
                `;
                
                positionBoard.appendChild(div);
            });
        }

        function showActionModal(actionType) {
            if (!gameData.selectedClassroom) {
                alert('กรุณาเลือกห้องเรียนก่อน');
                return;
            }
            
            currentAction = actionType;
            const action = actions[actionType];
            document.getElementById('actionTitle').textContent = `${action.title} (${action.points > 0 ? '+' : ''}${action.points} คะแนน)`;
            document.getElementById('actionModal').classList.remove('hidden');
        }

        function closeActionModal() {
            document.getElementById('actionModal').classList.add('hidden');
            currentAction = null;
        }

        function applyAction() {
            const studentId = document.getElementById('actionStudentSelect').value;
            
            if (!studentId || !currentAction) return;
            
            const action = actions[currentAction];
            let targetStudents = [];
            
            if (studentId === 'all') {
                targetStudents = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            } else {
                const student = gameData.students.find(s => s.id == studentId);
                if (student) targetStudents = [student];
            }
            
            targetStudents.forEach(student => {
                const oldPoints = student.points;
                student.points = Math.max(0, student.points + action.points);
                
                // ตรวจสอบการเลื่อนระดับ
                const oldStage = getCurrentStage(oldPoints);
                const newStage = getCurrentStage(student.points);
                
                const notification = {
                    id: Date.now() + Math.random(),
                    message: action.message,
                    effect: action.effect,
                    timestamp: new Date().toISOString(),
                    viewed: false
                };
                student.notifications.push(notification);
                
                // ถ้าเลื่อนระดับ ให้เพิ่มการแจ้งเตือนพิเศษ
                if (newStage.points > oldStage.points) {
                    const levelUpNotification = {
                        id: Date.now() + Math.random() + 1,
                        message: `🎉 ยินดีด้วย! เลื่อนระดับเป็น "${newStage.name}" แล้ว! ✨`,
                        effect: 'levelup',
                        timestamp: new Date().toISOString(),
                        viewed: false
                    };
                    student.notifications.push(levelUpNotification);
                }
                
                // ถ้าถึงระดับ 12 ให้เตรียมเลือกต้นไม้ใหม่
                if (newStage.level >= 12 && oldStage.level < 12) {
                    student.needsTreeSelection = true;
                    
                    const newTreeNotification = {
                        id: Date.now() + Math.random() + 2,
                        message: `🌟 ยินดีด้วย! ต้นไม้ของคุณเติบโตเต็มที่แล้ว! เลือกต้นไม้ใหม่เพื่อเริ่มต้นใหม่ 🌱`,
                        effect: 'newtree',
                        timestamp: new Date().toISOString(),
                        viewed: false
                    };
                    student.notifications.push(newTreeNotification);
                }
            });
            
            saveData();
            updateStudentsGrid();
            closeActionModal();
            
            alert(`ใช้การกระทำ "${action.title}" กับ ${targetStudents.length} คน สำเร็จ!`);
        }

        function showMissionCompleteModal(missionId) {
            const mission = gameData.missions.find(m => m.id === missionId);
            if (!mission) return;
            
            gameData.selectedMission = missionId;
            document.getElementById('missionCompleteTitle').textContent = `ให้รางวัลภารกิจ: ${mission.title}`;
            document.getElementById('missionCompleteInfo').textContent = `รางวัล: ${mission.reward} คะแนน`;
            
            // อัปเดต select นักเรียน
            const select = document.getElementById('missionCompleteStudentSelect');
            select.innerHTML = '<option value="">เลือกนักเรียน</option><option value="all">นักเรียนทั้งหมด</option>';
            
            const students = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                select.appendChild(option);
            });
            
            document.getElementById('missionCompleteModal').classList.remove('hidden');
        }

        function closeMissionCompleteModal() {
            document.getElementById('missionCompleteModal').classList.add('hidden');
            gameData.selectedMission = null;
        }

        function completeMission() {
            const studentId = document.getElementById('missionCompleteStudentSelect').value;
            const mission = gameData.missions.find(m => m.id === gameData.selectedMission);
            
            if (!studentId || !mission) return;
            
            let targetStudents = [];
            
            if (studentId === 'all') {
                targetStudents = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            } else {
                const student = gameData.students.find(s => s.id == studentId);
                if (student) targetStudents = [student];
            }
            
            targetStudents.forEach(student => {
                const oldPoints = student.points;
                student.points = Math.max(0, student.points + mission.reward);
                
                // ตรวจสอบการเลื่อนระดับ
                const oldStage = getCurrentStage(oldPoints);
                const newStage = getCurrentStage(student.points);
                
                const notification = {
                    id: Date.now() + Math.random(),
                    message: `🎉 ทำภารกิจ "${mission.title}" สำเร็จ! ได้รับ ${mission.reward} คะแนน`,
                    effect: 'mission_complete',
                    timestamp: new Date().toISOString(),
                    viewed: false
                };
                student.notifications.push(notification);
                
                // ถ้าเลื่อนระดับ ให้เพิ่มการแจ้งเตือนพิเศษ
                if (newStage.points > oldStage.points) {
                    const levelUpNotification = {
                        id: Date.now() + Math.random() + 1,
                        message: `🎉 ยินดีด้วย! เลื่อนระดับเป็น "${newStage.name}" แล้ว! ✨`,
                        effect: 'levelup',
                        timestamp: new Date().toISOString(),
                        viewed: false
                    };
                    student.notifications.push(levelUpNotification);
                }
                
                // ถ้าถึงระดับ 12 ให้เตรียมเลือกต้นไม้ใหม่
                if (newStage.level >= 12 && oldStage.level < 12) {
                    student.needsTreeSelection = true;
                    
                    const newTreeNotification = {
                        id: Date.now() + Math.random() + 2,
                        message: `🌟 ยินดีด้วย! ต้นไม้ของคุณเติบโตเต็มที่แล้ว! เลือกต้นไม้ใหม่เพื่อเริ่มต้นใหม่ 🌱`,
                        effect: 'newtree',
                        timestamp: new Date().toISOString(),
                        viewed: false
                    };
                    student.notifications.push(newTreeNotification);
                }
            });
            
            saveData();
            updateStudentsGrid();
            closeMissionCompleteModal();
            
            alert(`ให้รางวัลภารกิจ "${mission.title}" กับ ${targetStudents.length} คน สำเร็จ!`);
        }

        function showMissions() {
            const student = gameData.currentStudent;
            if (!student) return;
            
            const modal = document.getElementById('missionModal');
            const list = modal.querySelector('#missionsList');
            
            list.innerHTML = '';
            
            const missions = gameData.missions.filter(m => m.classroomId === student.classroomId && m.active);
            
            if (missions.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4">ไม่มีภารกิจในขณะนี้</div>';
            } else {
                missions.forEach(mission => {
                    const div = document.createElement('div');
                    div.className = 'p-4 rounded-xl border-2 bg-orange-50 border-orange-200';
                    div.innerHTML = `
                        <div class="font-bold text-orange-800 mb-2">${mission.title}</div>
                        <div class="text-gray-700 mb-3">${mission.description}</div>
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-green-600">รางวัล: ${mission.reward} คะแนน</span>
                            <span class="text-sm text-gray-500">${new Date(mission.createdAt).toLocaleDateString('th-TH')}</span>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
            
            modal.classList.remove('hidden');
            updateMissionBadge();
        }

        function closeMissionModal() {
            document.getElementById('missionModal').classList.add('hidden');
        }

        function updateMissionBadge() {
            const student = gameData.currentStudent;
            if (!student) return;
            
            const missions = gameData.missions.filter(m => m.classroomId === student.classroomId && m.active);
            const badge = document.getElementById('missionBadge');
            
            if (missions.length > 0) {
                badge.textContent = missions.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function showWheelModal() {
            if (!gameData.selectedClassroom) {
                alert('กรุณาเลือกห้องเรียนก่อน');
                return;
            }
            
            const students = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            if (students.length === 0) {
                alert('ไม่มีนักเรียนในห้องเรียนนี้');
                return;
            }
            
            document.getElementById('wheelModal').classList.remove('hidden');
            document.getElementById('wheelResult').classList.add('hidden');
            document.getElementById('spinButton').disabled = false;
            document.getElementById('spinButton').textContent = '🎲 หมุนวงล้อ';
            
            // สร้างวงล้อใหม่
            drawWheel(students);
        }

        function closeWheelModal() {
            document.getElementById('wheelModal').classList.add('hidden');
        }

        function drawWheel(students) {
            // คำนวณขนาดที่เหมาะสมตามหน้าจอ
            const container = document.getElementById('wheelContainer');
            const maxSize = Math.min(window.innerWidth - 100, window.innerHeight - 200, 500);
            const wheelSize = Math.max(300, maxSize);
            
            // ตั้งค่าขนาดของ container และ canvas
            container.style.width = wheelSize + 'px';
            container.style.height = wheelSize + 'px';
            
            const wheelCanvas = document.getElementById('wheelCanvas');
            wheelCanvas.style.width = wheelSize + 'px';
            wheelCanvas.style.height = wheelSize + 'px';
            
            const canvas = document.getElementById('wheelSegments');
            canvas.width = wheelSize * 2; // เพิ่มความละเอียด
            canvas.height = wheelSize * 2;
            canvas.style.width = wheelSize + 'px';
            canvas.style.height = wheelSize + 'px';
            
            const ctx = canvas.getContext('2d');
            ctx.scale(2, 2); // ปรับ scale สำหรับความคมชัด
            
            const centerX = wheelSize / 2;
            const centerY = wheelSize / 2;
            const radius = (wheelSize / 2) - 25;
            
            // ล้างแคนวาส
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // สีที่สวยงามและมีความคมชัด
            const colors = [
                '#FF6B9D', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#FF8A80', '#81C784',
                '#FFB74D', '#E57373', '#64B5F6', '#AED581', '#FFD54F',
                '#F06292', '#4DB6AC', '#7986CB', '#A1C181', '#FFCC80'
            ];
            
            const anglePerSegment = (2 * Math.PI) / students.length;
            
            // วาดเงาของวงล้อ
            ctx.save();
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 15;
            ctx.shadowOffsetX = 5;
            ctx.shadowOffsetY = 5;
            
            // วาดวงกลมพื้นหลัง
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            ctx.restore();
            
            // วาดส่วนของวงล้อ
            students.forEach((student, index) => {
                const startAngle = index * anglePerSegment - Math.PI / 2;
                const endAngle = (index + 1) * anglePerSegment - Math.PI / 2;
                
                // สร้าง gradient สำหรับแต่ละส่วน
                const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                const baseColor = colors[index % colors.length];
                gradient.addColorStop(0, lightenColor(baseColor, 20));
                gradient.addColorStop(0.7, baseColor);
                gradient.addColorStop(1, darkenColor(baseColor, 20));
                
                // วาดส่วนโค้ง
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // เส้นขอบสีขาวหนา
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 4;
                ctx.stroke();
                
                // เส้นขอบทองคำบาง ๆ
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // วาดข้อความ
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + anglePerSegment / 2);
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // ปรับขนาดฟอนต์ตามขนาดวงล้อและจำนวนนักเรียน
                const baseFontSize = Math.max(14, Math.min(24, wheelSize / 18));
                const adjustedFontSize = students.length > 15 ? baseFontSize * 0.7 : 
                                       students.length > 10 ? baseFontSize * 0.85 : baseFontSize;
                
                // ตัดชื่อถ้ายาวเกินไป
                let displayName = student.name;
                const maxLength = students.length > 15 ? 5 : students.length > 10 ? 7 : 12;
                if (displayName.length > maxLength) {
                    displayName = displayName.substring(0, maxLength) + '...';
                }
                
                // วาดข้อความ
                ctx.font = `bold ${adjustedFontSize}px Kanit, sans-serif`;
                const textRadius = radius * 0.68;
                
                // เงาข้อความ
                ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                ctx.shadowBlur = 4;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                // ข้อความสีขาวพร้อมเส้นขอบดำหนา
                ctx.fillStyle = '#ffffff';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 4;
                ctx.strokeText(displayName, textRadius, 0);
                ctx.fillText(displayName, textRadius, 0);
                
                ctx.restore();
            });
            
            // วาดวงกลมกลางที่สวยงาม
            const centerRadius = Math.max(25, wheelSize / 12);
            
            // เงาของวงกลมกลาง
            ctx.save();
            ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
            ctx.shadowBlur = 10;
            ctx.shadowOffsetX = 2;
            ctx.shadowOffsetY = 2;
            
            // วงกลมกลางแบบ gradient
            const centerGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, centerRadius);
            centerGradient.addColorStop(0, '#FFD700');
            centerGradient.addColorStop(0.3, '#FFA500');
            centerGradient.addColorStop(1, '#FF8C00');
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, centerRadius, 0, 2 * Math.PI);
            ctx.fillStyle = centerGradient;
            ctx.fill();
            
            // เส้นขอบวงกลมกลาง
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.restore();
            
            // ไอคอนกลางที่ใหญ่ขึ้น
            ctx.font = `${centerRadius}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = '#ffffff';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.strokeText('🎯', centerX, centerY);
            ctx.fillText('🎯', centerX, centerY);
            
            // ล้างชื่อเก่า
            document.getElementById('wheelNames').innerHTML = '';
        }
        
        // ฟังก์ชันช่วยสำหรับการปรับสี
        function lightenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        function darkenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return "#" + (0x1000000 + (R > 255 ? 255 : R < 0 ? 0 : R) * 0x10000 +
                (G > 255 ? 255 : G < 0 ? 0 : G) * 0x100 +
                (B > 255 ? 255 : B < 0 ? 0 : B)).toString(16).slice(1);
        }

        function spinWheel() {
            const allStudents = gameData.students.filter(s => s.classroomId === gameData.selectedClassroom);
            if (allStudents.length === 0) return;
            
            // ตรวจสอบประวัติการหมุนของห้องนี้
            const classroomId = gameData.selectedClassroom;
            if (!gameData.wheelHistory[classroomId]) {
                gameData.wheelHistory[classroomId] = {
                    availableStudents: [...allStudents.map(s => s.id)],
                    usedStudents: []
                };
            }
            
            const wheelHistory = gameData.wheelHistory[classroomId];
            
            // ถ้าทุกคนได้รับการเลือกแล้ว ให้รีเซ็ต
            if (wheelHistory.availableStudents.length === 0) {
                wheelHistory.availableStudents = [...allStudents.map(s => s.id)];
                wheelHistory.usedStudents = [];
                
                // แจ้งเตือนว่าเริ่มรอบใหม่
                showFloatingNotification('🔄 เริ่มรอบใหม่! ทุกคนได้โอกาสใหม่', 'info');
            }
            
            // เลือกเฉพาะนักเรียนที่ยังไม่ได้รับการเลือก
            const availableStudents = allStudents.filter(s => wheelHistory.availableStudents.includes(s.id));
            
            const spinButton = document.getElementById('spinButton');
            spinButton.disabled = true;
            spinButton.textContent = '🌀 กำลังหมุน...';
            
            const wheel = document.getElementById('wheelCanvas');
            const wheelResult = document.getElementById('wheelResult');
            wheelResult.classList.add('hidden');
            
            // เพิ่มเอฟเฟกต์ขณะหมุน
            wheel.classList.add('wheel-spinning', 'wheel-glow');
            
            // เสียงหมุน
            if (gameData.settings.soundEnabled) {
                playSound('spin');
            }
            
            // เลือกผู้ชนะจากรายชื่อที่ยังไม่ได้รับการเลือก
            const winnerIndex = Math.floor(Math.random() * availableStudents.length);
            const winner = availableStudents[winnerIndex];
            
            // คำนวณมุมที่จะหยุด (ให้ตรงกับผู้ชนะ)
            const allStudentIndex = allStudents.findIndex(s => s.id === winner.id);
            const segmentAngle = 360 / allStudents.length;
            const targetAngle = (allStudentIndex * segmentAngle) + (segmentAngle / 2);
            
            // คำนวณการหมุนให้ดูสมจริง
            const spins = 6 + Math.random() * 4; // 6-10 รอบ
            const finalAngle = 360 - targetAngle; // หมุนให้ตรงกับเป้าหมาย
            const totalRotation = spins * 360 + finalAngle;
            
            // ใช้ CSS animation แบบ smooth
            wheel.style.transition = 'transform 4.5s cubic-bezier(0.23, 1, 0.32, 1)';
            wheel.style.transform = `rotate(${totalRotation}deg)`;
            
            // เอฟเฟกต์ระหว่างหมุน
            let spinSoundInterval;
            if (gameData.settings.soundEnabled) {
                spinSoundInterval = setInterval(() => {
                    playTone(new (window.AudioContext || window.webkitAudioContext)(), 
                           200 + Math.random() * 100, 0.05, 0.1);
                }, 100);
            }
            
            setTimeout(() => {
                // หยุดเสียงหมุน
                if (spinSoundInterval) {
                    clearInterval(spinSoundInterval);
                }
                
                // ลบเอฟเฟกต์หมุน
                wheel.classList.remove('wheel-spinning');
                
                // อัปเดตประวัติการหมุน
                wheelHistory.availableStudents = wheelHistory.availableStudents.filter(id => id !== winner.id);
                wheelHistory.usedStudents.push(winner.id);
                
                // แสดงผลลัพธ์พร้อมเอฟเฟกต์
                setTimeout(() => {
                    wheel.classList.remove('wheel-glow');
                    document.getElementById('winnerName').textContent = winner.name;
                    wheelResult.classList.remove('hidden');
                    
                    // เพิ่มเอฟเฟกต์ชนะ
                    wheelResult.style.animation = 'bounceIn 0.8s ease-out';
                    
                    // อัปเดตปุ่ม
                    const remainingCount = wheelHistory.availableStudents.length;
                    if (remainingCount > 0) {
                        spinButton.textContent = `🎲 หมุนอีกครั้ง (เหลือ ${remainingCount} คน)`;
                    } else {
                        spinButton.textContent = '🎉 หมุนรอบใหม่';
                    }
                    spinButton.disabled = false;
                    
                    // รีเซ็ตการหมุนสำหรับครั้งต่อไป
                    wheel.style.transition = 'none';
                    wheel.style.transform = `rotate(${finalAngle}deg)`;
                    
                    // ส่งการแจ้งเตือนให้ผู้ชนะ
                    const notification = {
                        id: Date.now(),
                        message: `🎯 คุณถูกเลือกจากวงล้อสุ่มชื่อ! ครูเรียกคุณ ✨`,
                        effect: 'winner',
                        timestamp: new Date().toISOString(),
                        viewed: false
                    };
                    winner.notifications.push(notification);
                    saveData();
                    
                    // เล่นเสียงชนะ
                    if (gameData.settings.soundEnabled) {
                        playSound('win');
                    }
                    
                    // แสดงพลุ
                    createWheelFireworks();
                }, 300);
            }, 4500);
        }
        
        function createWheelFireworks() {
            const wheelContainer = document.querySelector('.wheel-container');
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'];
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.style.position = 'absolute';
                    firework.style.width = '6px';
                    firework.style.height = '6px';
                    firework.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.borderRadius = '50%';
                    firework.style.left = '50%';
                    firework.style.top = '50%';
                    firework.style.pointerEvents = 'none';
                    firework.style.animation = `fireworkExplode 1.5s ease-out forwards`;
                    
                    const angle = (Math.PI * 2 * i) / 30;
                    const distance = 100 + Math.random() * 50;
                    firework.style.setProperty('--end-x', Math.cos(angle) * distance + 'px');
                    firework.style.setProperty('--end-y', Math.sin(angle) * distance + 'px');
                    
                    wheelContainer.appendChild(firework);
                    
                    setTimeout(() => {
                        if (firework.parentNode) {
                            firework.parentNode.removeChild(firework);
                        }
                    }, 1500);
                }, i * 30);
            }
        }

        function showFloatingNotification(message, type = 'success') {
            const container = document.getElementById('floatingNotifications');
            const notification = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 
                           type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            
            notification.className = `${bgColor} text-white px-6 py-3 rounded-xl shadow-lg notification-slide mb-2`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // ลบการแจ้งเตือนหลังจาก 4 วินาที
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.5s ease-in forwards';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 500);
                }
            }, 4000);
        }

        function updateStudentDashboard() {
            const student = gameData.currentStudent;
            if (!student) return;

            document.getElementById('studentWelcome').textContent = `ยินดีต้อนรับ, ${student.name}!`;
            
            // ตรวจสอบว่าต้องเลือกต้นไม้หรือไม่
            const currentStage = getCurrentStage(student.points);
            if (!student.treeType || student.needsTreeSelection || currentStage.level >= 12) {
                document.getElementById('treeSelection').classList.remove('hidden');
            } else {
                document.getElementById('treeSelection').classList.add('hidden');
            }

            // อัปเดตความก้าวหน้า
            const stage = getCurrentStage(student.points);
            const nextStage = getNextStage(student.points);
            
            document.getElementById('studentProgress').textContent = `Lv.${treeStages.indexOf(stage) + 1} - ${stage.name}`;
            document.getElementById('currentPoints').textContent = `${student.points} คะแนน`;
            document.getElementById('levelBadge').textContent = `Lv.${treeStages.indexOf(stage) + 1}`;
            
            // อัปเดตอันดับในห้อง
            updateStudentPosition();
            
            if (nextStage) {
                document.getElementById('nextLevel').textContent = `ถัดไป: ${nextStage.points} คะแนน`;
                const progress = ((student.points - stage.points) / (nextStage.points - stage.points)) * 100;
                document.getElementById('progressBar').style.width = `${Math.min(100, Math.max(0, progress))}%`;
            } else {
                document.getElementById('nextLevel').textContent = 'ระดับสูงสุดแล้ว!';
                document.getElementById('progressBar').style.width = '100%';
            }

            // อัปเดตการแสดงต้นไม้
            const treeDisplayElement = document.getElementById('treeDisplay');
            const treeDisplayHTML = getTreeDisplay(student);
            
            if (typeof treeDisplayHTML === 'string' && treeDisplayHTML.includes('<div')) {
                treeDisplayElement.innerHTML = treeDisplayHTML;
            } else {
                treeDisplayElement.textContent = treeDisplayHTML;
            }
            
            document.getElementById('treeInfo').textContent = `${stage.name} - ${stage.description}`;

            // อัปเดตจำนวนการแจ้งเตือน
            updateNotificationBadge();
            
            // อัปเดตจำนวนภารกิจ
            updateMissionBadge();
            
            // อัปเดตสวนต้นไม้
            updateGarden();
        }

        function updateGarden() {
            const student = gameData.currentStudent;
            if (!student || !student.garden || student.garden.length === 0) {
                document.getElementById('gardenSection').classList.add('hidden');
                return;
            }
            
            document.getElementById('gardenSection').classList.remove('hidden');
            document.getElementById('gardenCount').textContent = `${student.garden.length} ต้น`;
            
            const gardenGrid = document.getElementById('gardenGrid');
            gardenGrid.innerHTML = '';
            
            student.garden.forEach((tree, index) => {
                const treeType = customTreeTypes[tree.type] || treeTypes[tree.type];
                const div = document.createElement('div');
                div.className = 'glass-card p-4 rounded-xl text-center hover:scale-105 transition-all cursor-pointer';
                
                const completedDate = new Date(tree.completedAt).toLocaleDateString('th-TH');
                
                div.innerHTML = `
                    <div class="text-4xl mb-2">${treeType ? treeType.fruit : '🌳'}</div>
                    <div class="font-bold text-sm ${treeType ? treeType.color : 'text-green-600'}">${treeType ? treeType.name : 'ต้นไม้'}</div>
                    <div class="text-xs text-gray-500 mt-1">Lv.${tree.level}</div>
                    <div class="text-xs text-gray-400">${completedDate}</div>
                    <div class="text-xs text-purple-600 font-bold">${tree.finalPoints} คะแนน</div>
                `;
                
                // เพิ่มเอฟเฟกต์เมื่อคลิก
                div.onclick = () => {
                    showFloatingNotification(`🌟 ${treeType ? treeType.name : 'ต้นไม้'} ระดับ ${tree.level} - เสร็จเมื่อ ${completedDate}`, 'info');
                    div.style.animation = 'bounceIn 0.5s ease-out';
                    setTimeout(() => {
                        div.style.animation = '';
                    }, 500);
                };
                
                gardenGrid.appendChild(div);
            });
        }

        function updateStudentPosition() {
            const student = gameData.currentStudent;
            if (!student) return;
            
            // หานักเรียนในห้องเดียวกัน
            const classmates = gameData.students.filter(s => s.classroomId === student.classroomId);
            
            // เรียงลำดับตามคะแนน
            const sortedStudents = classmates.sort((a, b) => b.points - a.points);
            
            // หาอันดับของนักเรียนปัจจุบัน
            const position = sortedStudents.findIndex(s => s.id === student.id) + 1;
            const totalStudents = classmates.length;
            
            // หาชื่อห้องเรียน
            const classroom = gameData.classrooms.find(c => c.id === student.classroomId);
            const classroomName = classroom ? classroom.name : 'ห้องเรียน';
            
            // อัปเดตการแสดงผล
            const positionElement = document.getElementById('studentPosition');
            let positionText = '';
            let positionEmoji = '';
            
            if (position === 1) {
                positionEmoji = '🥇';
                positionText = `${positionEmoji} อันดับที่ ${position} ใน${classroomName} (${totalStudents} คน)`;
            } else if (position === 2) {
                positionEmoji = '🥈';
                positionText = `${positionEmoji} อันดับที่ ${position} ใน${classroomName} (${totalStudents} คน)`;
            } else if (position === 3) {
                positionEmoji = '🥉';
                positionText = `${positionEmoji} อันดับที่ ${position} ใน${classroomName} (${totalStudents} คน)`;
            } else {
                positionEmoji = '🏆';
                positionText = `${positionEmoji} อันดับที่ ${position} ใน${classroomName} (${totalStudents} คน)`;
            }
            
            positionElement.textContent = positionText;
            
            // เปลี่ยนสีตามอันดับ
            positionElement.className = position <= 3 ? 
                'text-yellow-600 font-bold text-lg' : 
                'text-purple-600 font-bold';
        }

        function selectTree(type) {
            const student = gameData.currentStudent;
            const currentStage = getCurrentStage(student.points);
            
            // ถ้าต้นไม้เก่าถึงระดับ 12 แล้ว ให้เก็บเข้าสวน
            if (student.treeType && currentStage.level >= 12) {
                if (!student.garden) student.garden = [];
                
                const completedTree = {
                    type: student.treeType,
                    completedAt: new Date().toISOString(),
                    finalPoints: student.points,
                    level: currentStage.level,
                    name: currentStage.name
                };
                
                student.garden.push(completedTree);
                
                // รีเซ็ตคะแนนสำหรับต้นไม้ใหม่
                student.points = 0;
                
                // แจ้งเตือนว่าต้นไม้เก่าถูกเก็บเข้าสวนแล้ว
                const treeTypeName = customTreeTypes[student.treeType] ? 
                    customTreeTypes[student.treeType].name : 
                    treeTypes[student.treeType]?.name || 'ต้นไม้';
                
                showFloatingNotification(`🌟 ${treeTypeName}ของคุณเติบโตเต็มที่แล้ว! เก็บเข้าสวนเรียบร้อย`, 'success');
            }
            
            // เลือกต้นไม้ใหม่
            student.treeType = type;
            student.needsTreeSelection = false;
            
            const newTreeTypeName = customTreeTypes[type] ? 
                customTreeTypes[type].name : 
                treeTypes[type]?.name || 'ต้นไม้';
            
            showFloatingNotification(`🌱 เริ่มปลูก${newTreeTypeName}ใหม่! ขอให้โชคดี`, 'success');
            
            saveData();
            updateStudentDashboard();
        }

        function getCurrentStage(points) {
            for (let i = treeStages.length - 1; i >= 0; i--) {
                if (points >= treeStages[i].points) {
                    return treeStages[i];
                }
            }
            return treeStages[0];
        }

        function getNextStage(points) {
            for (let i = 0; i < treeStages.length; i++) {
                if (points < treeStages[i].points) {
                    return treeStages[i];
                }
            }
            return null;
        }

        function getTreeDisplay(student) {
            if (!student.treeType) return '🌱';
            
            const stage = getCurrentStage(student.points);
            const stageIndex = treeStages.indexOf(stage);
            let treeType = treeTypes[student.treeType] || customTreeTypes[student.treeType];
            
            if (!treeType) {
                // ถ้าไม่พบ tree type ให้ใช้ default
                treeType = { fruit: '🌳', name: 'ต้นไม้' };
            }
            
            // ถ้าเป็น custom tree ที่มีรูปภาพสำหรับแต่ละระดับ
            if (treeType.isCustom && treeType.stageImages && treeType.stageImages[stageIndex]) {
                const imageData = treeType.stageImages[stageIndex];
                return `<div class="inline-block"><img src="${imageData}" class="w-20 h-20 md:w-24 md:h-24 object-cover rounded-lg" alt="${treeType.name} ระดับ ${stageIndex + 1}" onerror="this.src='🌳'; this.alt='ไม่สามารถโหลดรูปได้';"></div>`;
            }
            
            // ถ้าเป็น custom tree แบบเก่า (รูปเดียว)
            if (treeType.isCustom && treeType.fruit.includes('<img')) {
                // สำหรับ custom tree ให้แสดงเฉพาะในระดับสูง
                if (stage.points >= 200) {
                    return `<div class="inline-block">${treeType.fruit}</div>`;
                } else {
                    return stage.emoji; // แสดง emoji ปกติในระดับต่ำ
                }
            }
            
            return stage.emoji.replace(/🍎/g, treeType.fruit);
        }

        function updateNotificationBadge() {
            const student = gameData.currentStudent;
            if (!student) return;
            
            const unreadCount = student.notifications.filter(n => !n.viewed).length;
            const badge = document.getElementById('notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function showNotifications() {
            const student = gameData.currentStudent;
            if (!student) return;
            
            const modal = document.getElementById('notificationModal');
            const list = document.getElementById('notificationsList');
            
            list.innerHTML = '';
            
            if (student.notifications.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-4">ไม่มีการแจ้งเตือน</div>';
            } else {
                student.notifications.slice().reverse().forEach(notification => {
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-xl border-2 cursor-pointer transition-all ${
                        notification.viewed ? 'bg-gray-50 border-gray-200' : 'bg-blue-50 border-blue-300'
                    }`;
                    div.innerHTML = `
                        <div class="font-bold text-gray-800">${notification.message}</div>
                        <div class="text-sm text-gray-600 mt-1">
                            ${new Date(notification.timestamp).toLocaleString('th-TH')}
                        </div>
                        <div class="text-sm text-blue-600 mt-2">แตะเพื่อดูเอฟเฟกต์!</div>
                    `;
                    div.onclick = () => {
                        notification.viewed = true;
                        saveData();
                        updateNotificationBadge();
                        playEffect(notification.effect);
                        // ไม่ปิด modal ทันที ให้ดูเอฟเฟกต์ก่อน
                        setTimeout(() => {
                            closeNotificationModal();
                        }, 500);
                    };
                    list.appendChild(div);
                });
            }
            
            modal.classList.remove('hidden');
        }

        function closeNotificationModal() {
            document.getElementById('notificationModal').classList.add('hidden');
        }

        function playEffect(effectType) {
            const treeDisplay = document.getElementById('treeDisplay');
            const effectOverlay = document.getElementById('effectOverlay');
            
            // ล้างเอฟเฟกต์เก่า
            effectOverlay.innerHTML = '';
            treeDisplay.classList.remove('sick-effect');
            
            setTimeout(() => {
                switch(effectType) {
                    case 'water':
                        const waterDiv = document.createElement('div');
                        waterDiv.className = 'water-effect';
                        effectOverlay.appendChild(waterDiv);
                        
                        // สร้างหยดน้ำหลายหยด
                        for (let i = 0; i < 5; i++) {
                            setTimeout(() => {
                                const drop = document.createElement('div');
                                drop.className = 'water-drop';
                                drop.style.left = (40 + Math.random() * 20) + '%';
                                drop.style.animationDelay = (Math.random() * 0.5) + 's';
                                waterDiv.appendChild(drop);
                            }, i * 200);
                        }
                        playSound('water');
                        break;
                        
                    case 'fertilizer':
                        const fertilizerDiv = document.createElement('div');
                        fertilizerDiv.className = 'fertilizer-effect';
                        effectOverlay.appendChild(fertilizerDiv);
                        
                        // สร้างหยดปุ๋ยหลายหยด
                        for (let i = 0; i < 4; i++) {
                            setTimeout(() => {
                                const drop = document.createElement('div');
                                drop.className = 'fertilizer-drop';
                                drop.style.left = (35 + Math.random() * 30) + '%';
                                drop.style.animationDelay = (Math.random() * 0.3) + 's';
                                fertilizerDiv.appendChild(drop);
                            }, i * 300);
                        }
                        playSound('fertilizer');
                        break;
                        
                    case 'rain':
                        const rainDiv = document.createElement('div');
                        rainDiv.className = 'rain-effect';
                        effectOverlay.appendChild(rainDiv);
                        
                        // สร้างหยดฝนหลายหยด
                        for (let i = 0; i < 15; i++) {
                            setTimeout(() => {
                                const drop = document.createElement('div');
                                drop.className = 'rain-drop';
                                drop.style.left = Math.random() * 100 + '%';
                                drop.style.animationDelay = (Math.random() * 0.5) + 's';
                                rainDiv.appendChild(drop);
                            }, i * 100);
                        }
                        playSound('rain');
                        break;
                        
                    case 'worm':
                        const wormDiv = document.createElement('div');
                        wormDiv.className = 'worm-effect';
                        effectOverlay.appendChild(wormDiv);
                        
                        // สร้างหนอน
                        const worm = document.createElement('div');
                        worm.className = 'worm-body';
                        worm.style.left = '20%';
                        worm.style.top = '70%';
                        wormDiv.appendChild(worm);
                        playSound('worm');
                        break;
                        
                    case 'sick':
                        treeDisplay.classList.add('sick-effect');
                        playSound('sick');
                        break;
                        
                    case 'storm':
                        const stormDiv = document.createElement('div');
                        stormDiv.className = 'storm-effect';
                        effectOverlay.appendChild(stormDiv);
                        
                        // สร้างฟ้าผ่าหลายครั้ง
                        for (let i = 0; i < 3; i++) {
                            setTimeout(() => {
                                const lightning = document.createElement('div');
                                lightning.className = 'lightning';
                                lightning.style.left = (20 + Math.random() * 60) + '%';
                                lightning.style.top = '10%';
                                lightning.style.animationDelay = (Math.random() * 0.2) + 's';
                                stormDiv.appendChild(lightning);
                                
                                // ลบฟ้าผ่าหลังจากแอนิเมชันเสร็จ
                                setTimeout(() => {
                                    if (lightning.parentNode) {
                                        lightning.parentNode.removeChild(lightning);
                                    }
                                }, 500);
                            }, i * 600);
                        }
                        playSound('storm');
                        break;
                        
                    case 'levelup':
                        treeDisplay.classList.add('level-up-animation');
                        createConfetti();
                        playSound('levelup');
                        setTimeout(() => {
                            treeDisplay.classList.add('tree-transition');
                        }, 500);
                        break;
                        
                    case 'newtree':
                        createConfetti();
                        playSound('win');
                        setTimeout(() => {
                            updateStudentDashboard(); // รีเฟรชเพื่อแสดงการเลือกต้นไม้ใหม่
                        }, 1000);
                        break;
                        
                    case 'winner':
                        treeDisplay.classList.add('level-up-animation');
                        createConfetti();
                        playSound('winner');
                        break;
                        
                    case 'mission':
                        treeDisplay.classList.add('pulse-glow');
                        createSparkles();
                        playSound('mission');
                        break;
                        
                    case 'mission_complete':
                        treeDisplay.classList.add('level-up-animation');
                        createConfetti();
                        playSound('mission_complete');
                        break;
                        
                    case 'announcement':
                        treeDisplay.classList.add('floating');
                        createNotificationEffect();
                        playSound('announcement');
                        break;
                        
                    case 'tree_change':
                        treeDisplay.classList.add('level-up-animation');
                        createTreeChangeEffect();
                        playSound('tree_change');
                        setTimeout(() => {
                            updateStudentDashboard(); // รีเฟรชเพื่อแสดงต้นไม้ใหม่
                        }, 1000);
                        break;
                }
                
                // ล้างเอฟเฟกต์หลังจากเวลาผ่านไป
                setTimeout(() => {
                    effectOverlay.innerHTML = '';
                    treeDisplay.classList.remove('sick-effect', 'level-up-animation', 'tree-transition', 'pulse-glow', 'floating');
                }, 3000);
            }, 100);
        }

        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                switch(type) {
                    case 'water':
                        playTone(audioContext, 400, 0.3, 0.2);
                        setTimeout(() => playTone(audioContext, 350, 0.2, 0.1), 200);
                        break;
                    case 'fertilizer':
                        playTone(audioContext, 600, 0.4, 0.15);
                        setTimeout(() => playTone(audioContext, 650, 0.3, 0.1), 300);
                        break;
                    case 'rain':
                        for(let i = 0; i < 8; i++) {
                            setTimeout(() => playTone(audioContext, 300 + Math.random() * 200, 0.1, 0.05), i * 150);
                        }
                        break;
                    case 'worm':
                        playTone(audioContext, 200, 0.5, 0.1);
                        setTimeout(() => playTone(audioContext, 180, 0.3, 0.08), 400);
                        break;
                    case 'sick':
                        playTone(audioContext, 150, 0.8, 0.08);
                        setTimeout(() => playTone(audioContext, 120, 0.5, 0.06), 600);
                        break;
                    case 'storm':
                        playTone(audioContext, 100, 1.2, 0.15);
                        setTimeout(() => playTone(audioContext, 80, 0.8, 0.1), 800);
                        break;
                    case 'win':
                        playTone(audioContext, 523, 0.3, 0.2); // C
                        setTimeout(() => playTone(audioContext, 659, 0.3, 0.2), 300); // E
                        setTimeout(() => playTone(audioContext, 784, 0.6, 0.25), 600); // G
                        break;
                    case 'levelup':
                        playTone(audioContext, 523, 0.2, 0.15); // C
                        setTimeout(() => playTone(audioContext, 659, 0.2, 0.15), 200); // E
                        setTimeout(() => playTone(audioContext, 784, 0.2, 0.15), 400); // G
                        setTimeout(() => playTone(audioContext, 1047, 0.4, 0.2), 600); // C high
                        break;
                    case 'spin':
                        for(let i = 0; i < 10; i++) {
                            setTimeout(() => playTone(audioContext, 200 + i * 20, 0.1, 0.05), i * 100);
                        }
                        break;
                    case 'winner':
                        playTone(audioContext, 659, 0.3, 0.2); // E
                        setTimeout(() => playTone(audioContext, 784, 0.3, 0.2), 200); // G
                        setTimeout(() => playTone(audioContext, 1047, 0.5, 0.25), 400); // C high
                        break;
                    case 'mission':
                        playTone(audioContext, 440, 0.2, 0.15); // A
                        setTimeout(() => playTone(audioContext, 554, 0.2, 0.15), 150); // C#
                        setTimeout(() => playTone(audioContext, 659, 0.3, 0.2), 300); // E
                        break;
                    case 'mission_complete':
                        playTone(audioContext, 523, 0.2, 0.2); // C
                        setTimeout(() => playTone(audioContext, 659, 0.2, 0.2), 200); // E
                        setTimeout(() => playTone(audioContext, 784, 0.2, 0.2), 400); // G
                        setTimeout(() => playTone(audioContext, 1047, 0.4, 0.25), 600); // C high
                        setTimeout(() => playTone(audioContext, 1319, 0.3, 0.2), 800); // E high
                        break;
                    case 'announcement':
                        playTone(audioContext, 880, 0.3, 0.15); // A high
                        setTimeout(() => playTone(audioContext, 784, 0.2, 0.12), 300); // G
                        setTimeout(() => playTone(audioContext, 659, 0.2, 0.1), 500); // E
                        break;
                    case 'tree_change':
                        playTone(audioContext, 440, 0.2, 0.15); // A
                        setTimeout(() => playTone(audioContext, 523, 0.2, 0.15), 200); // C
                        setTimeout(() => playTone(audioContext, 659, 0.2, 0.15), 400); // E
                        setTimeout(() => playTone(audioContext, 784, 0.3, 0.2), 600); // G
                        setTimeout(() => playTone(audioContext, 880, 0.3, 0.2), 800); // A high
                        break;
                }
            } catch(e) {
                console.log(`เล่นเสียง ${type}`);
            }
        }
        
        function createSparkles() {
            const container = document.getElementById('effectOverlay');
            const colors = ['#FFD700', '#FFA500', '#FF69B4', '#00CED1', '#98FB98'];
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.style.position = 'absolute';
                    sparkle.style.width = '4px';
                    sparkle.style.height = '4px';
                    sparkle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    sparkle.style.borderRadius = '50%';
                    sparkle.style.left = Math.random() * 100 + '%';
                    sparkle.style.top = Math.random() * 100 + '%';
                    sparkle.style.pointerEvents = 'none';
                    sparkle.style.animation = 'sparkle 1.5s ease-out forwards';
                    sparkle.style.boxShadow = '0 0 6px currentColor';
                    container.appendChild(sparkle);
                    
                    setTimeout(() => {
                        if (sparkle.parentNode) {
                            sparkle.parentNode.removeChild(sparkle);
                        }
                    }, 1500);
                }, i * 100);
            }
        }
        
        function createNotificationEffect() {
            const container = document.getElementById('effectOverlay');
            
            // สร้างวงกลมขยาย
            const circle = document.createElement('div');
            circle.style.position = 'absolute';
            circle.style.top = '50%';
            circle.style.left = '50%';
            circle.style.width = '20px';
            circle.style.height = '20px';
            circle.style.borderRadius = '50%';
            circle.style.border = '3px solid #3B82F6';
            circle.style.transform = 'translate(-50%, -50%)';
            circle.style.animation = 'notificationRipple 1.5s ease-out forwards';
            circle.style.pointerEvents = 'none';
            container.appendChild(circle);
            
            setTimeout(() => {
                if (circle.parentNode) {
                    circle.parentNode.removeChild(circle);
                }
            }, 1500);
        }
        
        function createConfetti() {
            const container = document.getElementById('effectOverlay');
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
            
            for (let i = 0; i < 20; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-particle';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    container.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentNode) {
                            confetti.parentNode.removeChild(confetti);
                        }
                    }, 2000);
                }, i * 50);
            }
        }

        function createTreeChangeEffect() {
            const container = document.getElementById('effectOverlay');
            const colors = ['#FF69B4', '#9370DB', '#00CED1', '#FFD700', '#FF6347'];
            
            // สร้างวงกลมสีรุ้ง
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const circle = document.createElement('div');
                    circle.style.position = 'absolute';
                    circle.style.width = '8px';
                    circle.style.height = '8px';
                    circle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    circle.style.borderRadius = '50%';
                    circle.style.left = '50%';
                    circle.style.top = '50%';
                    circle.style.pointerEvents = 'none';
                    circle.style.animation = 'sparkle 2s ease-out forwards';
                    circle.style.boxShadow = '0 0 10px currentColor';
                    
                    const angle = (Math.PI * 2 * i) / 12;
                    const distance = 60 + Math.random() * 40;
                    circle.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px)`;
                    
                    container.appendChild(circle);
                    
                    setTimeout(() => {
                        if (circle.parentNode) {
                            circle.parentNode.removeChild(circle);
                        }
                    }, 2000);
                }, i * 100);
            }
            
            // เพิ่มข้อความ "เปลี่ยนต้นไม้!"
            const text = document.createElement('div');
            text.style.position = 'absolute';
            text.style.top = '120%';
            text.style.left = '50%';
            text.style.transform = 'translateX(-50%)';
            text.style.color = '#9370DB';
            text.style.fontWeight = 'bold';
            text.style.fontSize = '16px';
            text.style.textShadow = '0 2px 4px rgba(0,0,0,0.3)';
            text.style.animation = 'float 2s ease-out';
            text.textContent = '🎨 เปลี่ยนต้นไม้!';
            container.appendChild(text);
            
            setTimeout(() => {
                if (text.parentNode) {
                    text.parentNode.removeChild(text);
                }
            }, 2000);
        }

        function playTone(audioContext, frequency, duration, volume) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        // ฟังก์ชันการตั้งค่า
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            updateSettingsUI();
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
        }
        
        function updateSettingsUI() {
            const settings = gameData.settings;
            document.getElementById('soundToggle').textContent = settings.soundEnabled ? 'เปิด' : 'ปิด';
            document.getElementById('soundToggle').className = settings.soundEnabled ? 
                'bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-bold' :
                'bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-bold';
            
            document.getElementById('volumeSlider').value = settings.volume;
            
            document.getElementById('motionToggle').textContent = settings.reducedMotion ? 'เปิด' : 'ปิด';
            document.getElementById('motionToggle').className = settings.reducedMotion ? 
                'bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-xl font-bold' :
                'bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-xl font-bold';
            
            document.getElementById('fontSizeSelect').value = settings.fontSize;
            
            document.getElementById('contrastToggle').textContent = settings.highContrast ? 'สูง' : 'ปกติ';
            document.getElementById('contrastToggle').className = settings.highContrast ? 
                'bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl font-bold' :
                'bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-xl font-bold';
        }
        
        function toggleSound() {
            gameData.settings.soundEnabled = !gameData.settings.soundEnabled;
            saveData();
            updateSettingsUI();
        }
        
        function toggleMotion() {
            gameData.settings.reducedMotion = !gameData.settings.reducedMotion;
            saveData();
            updateSettingsUI();
            applyMotionSettings();
        }
        
        function toggleContrast() {
            gameData.settings.highContrast = !gameData.settings.highContrast;
            saveData();
            updateSettingsUI();
            applyContrastSettings();
        }
        
        function applyMotionSettings() {
            if (gameData.settings.reducedMotion) {
                document.body.classList.add('reduced-motion');
            } else {
                document.body.classList.remove('reduced-motion');
            }
        }
        
        function applyContrastSettings() {
            if (gameData.settings.highContrast) {
                document.body.classList.add('high-contrast');
            } else {
                document.body.classList.remove('high-contrast');
            }
        }
        
        // ฟังก์ชัน View-as-Student
        function viewAsStudent(studentId) {
            const student = gameData.students.find(s => s.id == studentId);
            if (!student) return;
            
            const stage = getCurrentStage(student.points);
            const nextStage = getNextStage(student.points);
            
            document.getElementById('studentViewContent').innerHTML = `
                <div class="mb-6">
                    <h4 class="text-xl font-bold text-green-600 mb-2">${student.name}</h4>
                    <p class="text-gray-600">รหัส: ${student.code}</p>
                </div>
                
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-gray-700">${student.points} คะแนน</span>
                        <span class="font-bold text-green-600">${nextStage ? `ถัดไป: ${nextStage.points} คะแนน` : 'ระดับสูงสุดแล้ว!'}</span>
                    </div>
                    <div class="bg-gray-200 rounded-full h-6 relative overflow-hidden">
                        <div class="progress-3d h-6 rounded-full transition-all duration-1000" style="width: ${nextStage ? ((student.points - stage.points) / (nextStage.points - stage.points)) * 100 : 100}%"></div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="text-8xl mb-4">${getTreeDisplay(student)}</div>
                    <div class="text-xl font-bold text-gray-800 mb-2">${stage.name}</div>
                    <div class="text-gray-600">${stage.description}</div>
                    ${student.treeType ? `<div class="text-blue-600 mt-2">ต้นไม้: ${treeTypes[student.treeType].name}</div>` : ''}
                </div>
                
                <div class="inline-block bg-gradient-to-r from-green-400 to-green-600 text-white px-6 py-2 rounded-full font-bold text-lg">
                    Lv.${treeStages.indexOf(stage) + 1}
                </div>
                
                ${student.garden && student.garden.length > 0 ? `
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h5 class="font-bold text-purple-600 mb-3">🏡 สวนต้นไม้ (${student.garden.length} ต้น)</h5>
                        <div class="grid grid-cols-3 md:grid-cols-4 gap-3">
                            ${student.garden.map(tree => {
                                const treeType = customTreeTypes[tree.type] || treeTypes[tree.type];
                                return `
                                    <div class="bg-purple-100 p-3 rounded-lg text-center">
                                        <div class="text-2xl mb-1">${treeType ? treeType.fruit : '🌳'}</div>
                                        <div class="text-xs text-purple-600 font-bold">${treeType ? treeType.name : 'ต้นไม้'}</div>
                                        <div class="text-xs text-gray-500">Lv.${tree.level}</div>
                                        <div class="text-xs text-green-600">${tree.finalPoints} คะแนน</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('viewAsStudentModal').classList.remove('hidden');
        }
        
        function closeViewAsStudentModal() {
            document.getElementById('viewAsStudentModal').classList.add('hidden');
        }

        // เริ่มต้นแดชบอร์ดหากผู้ใช้เข้าสู่ระบบแล้ว
        if (gameData.currentUser?.type === 'teacher') {
            showTeacherDashboard();
        } else if (gameData.currentStudent) {
            showStudentDashboard();
        }
        
        // ใช้การตั้งค่าเริ่มต้น
        applyMotionSettings();
        applyContrastSettings();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97494db460eb45c3',t:'MTc1NjEwNjE4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
